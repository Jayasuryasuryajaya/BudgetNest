{% extends "registration/base.html" %}

{% block content %}

<section id="dashboard" class="sections personal d-flex align-items-start flex-column" style="min-height: 130vh; position: relative;">
    
    
    <div id="contiContainer" class="d-flex flex-wrap" data-aos="fade-up" data-aos-delay="300" style="align-items: center; margin-top: 60px; margin-left:30px; margin-right:30px; justify-content: flex-start; border-radius: 15px; background-color: white; box-shadow: 0px 0 18px rgba(0, 0, 0, 0.1); max-width: auto; padding-bottom: 5px; padding-top: 5px;">
        {% if not conti %}
        <div id="conto_esempio" class="singolo-conto conto-box" style="margin: 10px; padding: 15px; border-radius: 10px; flex: 0 0 auto; color: white; background-color: #100d30; text-align: left; height: auto;">
            <i class="bi bi-bank"></i>
            <h4 style="margin-top: 5px; color: white;">Account Example</h4>
            <h6 style="color: white;">Balance: 0.00 €</h6>
        </div>
        {% endif %}
        {% for conto in conti %}
            <div id="singolo_conto_{{ conto.id }}" class="singolo-conto conto-box" style="margin: 10px; padding: 15px; border-radius: 10px; flex: 0 0 auto; color: white; background-color: #100d30; text-align: left; height: auto;">
            {% if conto.tipo == 'corrente' %}
                <i class="bi bi-bank"></i>
            {% elif conto.tipo == 'investimento' %}
                <i class="bi bi-bar-chart"></i>
            {% elif conto.tipo == 'risparmio' %}
                <i class="bi bi-safe"></i>
            {% elif conto.tipo == 'contante' %}
                <i class="bi bi-cash-coin"></i>
            {% endif %}
                <h3 style="margin-top:5px; color: white; font-size: 18px;">{{ conto.nome }}</h3> 
            <h6 style="color: white; font-size: 14px;">Balance: {{ conto.saldo }} €</h6>
            </div>
        {% endfor %}

        <div id="openModalBtn" class="singolo-conto conto-box" style="border-radius: 50%; background-color: #00995c; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; margin-right: 15px; margin-left: 15px;">  
            <i class="bi bi-plus" style="color: white; font-size: 20px;"></i> 
        </div>
    </div>
    
    
    <!-- Modale per il nuovo conto-->
    <div id="myModal" class="modal">   
        <div class="modal-content">
            <button class="close" style="border: none; background: none; font-size: 24px; cursor: pointer;">&times;</button>
            <div id="responseMessage" style="color: red;"></div>
            <h4 class = "color:#100d30 ">Insert your saving account</h4>
            <form id="contoForm" method="post"  class="mt-4">
                {% csrf_token %}
                <div class="mb-3">
                    {{ formConto.nome }}
                </div>
                <div class="mb-4">
                    {{ formConto.saldo }}
                </div>
                <div style="display: flex; justify-content: center;">
                    <button type="submit" style="background: #00995c; color:white; height: 50px; width: 100px; border-radius: 20px;  border: 1px solid #d3d3d3;">Create</button>
                </div>
                <input type="hidden" name="next" value="{{ next }}">
            </form>
        </div>
    </div>

    <!-- Piani risparmio e 3 tasti-->
    <div style="display: flex; justify-content: space-between; width: 100%; margin-top: 20px; padding: 0 30px;">
        <div id="leftDiv" style="flex: 2; margin-right: 30px; padding: 10px; border-radius: 8px; text-align: center;">
            <div id="pianiContainer" class="d-flex flex-wrap" data-aos="fade-up" data-aos-delay="300" style="align-items: center; margin-top: 70px; margin-left:30px; margin-right:30px; justify-content: flex-start; border-radius: 15px; background-color: white; border: 1px solid #00000; box-shadow: 0px 0 18px rgba(0, 0, 0, 0.1); max-height: auto; max-width: auto; padding-bottom: 10px; padding-top: 10px">
                {% if not pianiRisparmio %}
                    <div id= "singolo_piano_esempio"  class="singolo-piano conto-box" style="margin: 10px; padding: 15px; border-radius: 10px; flex: 0 0 auto; color: white; background-color: #100d30; text-align: center; height: auto; position: relative; width : 25%"> 
                        <div class="progress-circle" style="position: relative; display: inline-block; margin-bottom: 10px;">
                            <svg viewBox="0 0 36 36" class="circular-chart" style="width: 60px; height: 60px;">
                                <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="#ddd" stroke-width="3" />
                                <path class="circle" stroke-dasharray=" 70, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="#00995c" stroke-width="3" transform="rotate(180 18 18)"/>
                            </svg>
                        
                            <div class="logo" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
                                <i class="bi bi-safe" style="font-size: 20px;"></i>
                            </div>
                        </div>
                        <h4 style="margin-top: 5px; color: white; font-size: 18px;">Saving Plan Example</h3>
                        <h6 style="color: white; font-size: 14px;">Goal: XXXX €</h6>
                        <h6 style="color: white; font-size: 12px;  margin-top: 10px;">Due date :  YYYY-MM-DD</h6>
                    </div>
                {% endif %}

                {% for piano in pianiRisparmio %}
                    <div  id= "singolo_piano_{{ piano.id }}" class="singolo-piano conto-box" style="margin: 10px; padding: 15px; border-radius: 10px; flex: 0 0 auto; color: white; background-color: #100d30; text-align: center; height: auto; position: relative; width : 29.5%">
                        <div class="progress-circle" style="position: relative; display: inline-block; margin-bottom: 10px;">
                            <svg viewBox="0 0 36 36" class="circular-chart" style="width: 60px; height: 60px;">
                                <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="#ddd" stroke-width="3" />
                                <path class="circle"  stroke-dasharray=" {{piano.percentuale_completamento }}, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="#00995c" stroke-width="3" transform="rotate(180 18 18)"/>
                            </svg>
                            
                            <div class="logo" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
                                <i class="bi bi-safe" style="font-size: 20px;"></i>
                            </div>
                        </div>
                    
                        <h3 style="margin-top: 5px; color: white; font-size: 18px;">{{ piano.conto }}</h3>
                        <h6 style="color: white; font-size: 14px;">Goal: {{ piano.obbiettivo }} €</h6>
                        <h6 style="color: white; font-size: 12px;  margin-top: 10px;"> {{ piano.data_scadenza }} €</h6>
                     </div>
                
                {% endfor %}
            </div>    
        </div>
        <div  style="flex: 1; margin-left: 10px; padding: 10px; border-radius: 8px; text-align: center;"></div>
        <div id="rightDiv" style="flex: 1; margin-left: 10px; padding: 10px; border-radius: 8px; text-align: center;">
            <div id="contiContainer" class="d-flex flex-wrap" data-aos="fade-up" data-aos-delay="300" style="border-radius: 15px; background-color: white; padding: 10px;">
                <div class="d-flex flex-column" style="align-items: center; width: 100%;">
                    <button id= "newTransactionBtn" style="margin: 5px; padding: 10px 10px; border-radius: 8px; border: none; background-color: #00995c; color: white; cursor: pointer;  width: 90%;">
                        New transaction
                    </button>
                    <button id="newSavingPlan" style="margin: 5px; padding: 10px 10px; border-radius: 8px; border: none; background-color: #100d30; color: white; cursor: pointer;  width: 90%;">
                        New savings plan
                    </button>
                    <button   id= "newChallenge" style="margin: 5px; padding: 10px 10px; border-radius: 8px; border: none; background-color: #100d30; color: white; cursor: pointer;  width: 90%;">
                        New challenge
                    </button>
                </div>
            </div>
        </div>
    </div>


    <div id="sfidaContainer" class="d-flex flex-wrap" data-aos="fade-up" data-aos-delay="300" style="border-radius: 15px;margin-left: auto; margin-right: auto; background-color: white; padding: 10px; margin-top: 50px; width: 70%; text-align: center">
                {% if not challenge %}
                    <div class="challenge-row" style="display: flex; align-items: center; justify-content: space-between; margin: 10px; padding: 15px; border-radius: 10px; background-color: #100d30; color: white; width: calc(100% - 30px); height:55px">
                        <div class="icona-challenge" style="margin-right: 15px;">
                            <i class="bi bi-dash-circle-dotted" style="font-size: 25px; color: white;"></i>
                        </div>
                        <div class="dettagli-challenge" style="flex: 1; text-align: left;">
                            <h4 style="margin: 0; font-size: 18px; color: red;">Challenge Example</h4>
                            <p style="margin: 0; font-size: 14px; color: #ccc;">Sfidante: X | Sfidato: Y</p>
                        </div>
                    </div>
                {% else %}
                    {% for sfida in challenge %}
                  
                        <div id= "singola_sfida_{{ sfida.id }}" class="challenge-row" style="display: flex; align-items: center; justify-content: space-between; margin: 10px; padding: 15px; border-radius: 10px; background-color: #100d30; color: white; width: calc(100% - 30px); height:55px">
                            <!-- Sfidante a sinistra -->
                            <div class="sfidante" style="flex: 1; text-align: left;">
                                <h3 style="margin: 0; font-size: 18px; color: {% if sfida.importo_sfidante <= sfida.importo_sfidato %}#00995c{% else %}red{% endif %};">{{ sfida.sfidante }}</h3>
                                <p style="margin: 0; font-size: 14px; color: #ccc;">Spesa: €{{ sfida.importo_sfidante }}</p>
                            </div>
        
                        <!-- Barra della sfida centrale -->
            <div class="challenge-bar"  style="display: flex; height: 30px; width: 70%; border: 1px solid #d3d3d3; background-color: #f0f0f0; border-radius: 5px; overflow: hidden; position: relative;">
            {% if sfida.importo_sfidante < sfida.importo_sfidato %}
                <div class="bar" style="height: 100%; background-color: #00995c; width: {{ sfida.percentuale_sfidante }}%;"></div>
                <div class="bar" style="height: 100%; background-color: red; width: {{ sfida.percentuale_sfidato }}%;"></div>
            {% else %}
                {% if sfida.importo_sfidante == sfida.importo_sfidato %}
                    <div class="bar" style="height: 100%; background-color: #00995c; width: {{ sfida.percentuale_sfidante }}%;"></div>
                    <div class="bar" style="height: 100%; background-color: #00995c; width: {{ sfida.percentuale_sfidato }}%;"></div>
                {% else %}
                    <div class="bar" style="height: 100%; background-color: red; width: {{ sfida.percentuale_sfidante }}%;"></div>
                    <div class="bar" style="height: 100%; background-color: #00995c; width: {{ sfida.percentuale_sfidato }}%;"></div>
                {% endif %}
            {% endif %}

            <!-- Testo della categoria al centro -->
            <span style="position: absolute; left: 50%; transform: translateX(-50%); color: #333; font-weight: bold;">
                {{ sfida.categoria_target }} <!-- Assicurati che 'categoria' sia il campo corretto -->
            </span>
        </div>
                   
                        
                    <!-- Sfidato a destra -->
                    <div class="sfidato" style="flex: 1; text-align: right;">
                        <h3 style="margin: 0; font-size: 18px; color: {% if sfida.importo_sfidato <= sfida.importo_sfidante %}#00995c{% else %}red{% endif %};">{{ sfida.sfidato }}</h3>
                        <p style="margin: 0; font-size: 14px; color: #ccc;">Spesa: €{{ sfida.importo_sfidato }}</p>
                    </div>
                </div>
                
            {% endfor %}
        {% endif %}
       
        
       
        
    </div>
    


     <!-- Modale per il piano risparmio-->
     <div id="SavingsPlanModal" class="modal">
        <div class="modal-content" id = "SavingFormDiv">
            <button  id="SavingsPlanModalExit" style="border: none; background: none; font-size: 24px; cursor: pointer; float: right;">&times;</button>
            <div id="SavingsPlanResponseMessage" style="color: red; text-align: center; /* Centro il testo */font-size: 14px; margin-top: 10px;"></div>
            <h4 style="color: #100d30;">Insert your saving plan</h4>
            <form id="SavingsPlanForm" method="post" class="mt-4" >
                {% csrf_token %}
            
                <div class="mb-3" id =  "tipo">
                    {{ formPiano.obbiettivo }}
                </div>
                <div class="mb-3" id =  "tipo">
                    {{ formPiano.data_scadenza }}
                </div>
                <div class="mb-3" id =  "formSavingsContainer">
                    <label for="id_tipo" style="color: #100d30; padding-bottom:10px">Choose saving accout</label>
                    {{ formPiano.conto }}
                </div>
                            
                <div style="display: flex; justify-content: center;">
                    <button type="submit" style="background: #00995c; color:white; height: 50px; width: 100px; border-radius: 20px; border: 1px solid #d3d3d3; ">Create</button>
                </div>
                <input type="hidden" name="next" value="{{ next }}">
            </form>
        </div>
    </div>

    <!-- Modale per la nuova transazione -->
    <div id="transactionModal" class="modal">
        <div class="modal-content" id = "transactionFormDiv">
            <button  id="closeModelTransaction" style="border: none; background: none; font-size: 24px; cursor: pointer; float: right;">&times;</button>
            <div id="transactionResponseMessage" style="color: red; text-align: center; /* Centro il testo */ font-size: 14px; margin-top: 10px;"></div>
            <h4 style="color: #100d30;">Insert your transaction</h4>
            <form id="transactionForm" method="post" class="mt-4" >
                {% csrf_token %}
                <div class="mb-3" id ="tipoTra">
                    {{ formTransazione.tipo_transazione }}
                </div>
                <div id= "formTransazioneContainer"class="mb-4">
                    {{ formTransazione.conto}}
                </div>
                <div class="mb-4">
                    {{ formTransazione.importo }}
                </div>
                <div class="mb-4">
                    {{ formTransazione.data}}
                </div>
                <div class="mb-4">
                    {{ formTransazione.descrizione}}
                </div>
                <div class="mb-4 singola periodica delegata futura"  style="display:block;">
                    {{ formTransazione.categoria}}
                </div>
                <div class="mb-4 singola periodica delegata futura "  style="display:block;">
                    {{ formTransazione.sotto_categoria}}
                </div>
                <div class="mb-4 periodica" style="display:none;">
                    {{ formTransazione.tipo_rinnovo}}
                </div>
                <div class="mb-4 investimento"  style="display:none;">
                    {{ formTransazione.ticker}}
                </div>
                <div class="mb-4 investimento"  style="display:none;">
                    {{ formTransazione.numero_azioni}}
                </div>
                <div class="mb-4 investimento"  style="display:none;">
                    {{ formTransazione.prezzo_ordine}}
                </div>
                <div class="mb-4 investimento"  style="display:none;">
                    {{ formTransazione.borsa}}
                </div>
                <div class="mb-4 investimento"  style="display:none;">
                    {{ formTransazione.valuta}}
                </div>
                <div id= "formTransazioneContoArrivo" class="mb-4 trasferimento"  style="display:none;">
                    {{ formTransazione.conto_arrivo}}
                </div>
                <div style="display: flex; justify-content: center;">
                    <button type="submit" style="background: #00995c; color:white; height: 50px; width: 100px; border-radius: 20px; border: 1px solid #d3d3d3; ">Create</button>
                </div>
                <input type="hidden" name="next" value="{{ next }}">
            </form>
        </div>
    </div>

    <!-- Modale per la nuova sfida -->
    <div id="challengeModal" class="modal">
        <div class="modal-content">
            <button id = "closeModelChallenge" class="close" style="border: none; background: none; font-size: 24px; cursor: pointer;">&times;</button>
            <div id="responseMessageChallenge" style="color: red;"></div>
            <h4 style="color: #100d30;">Insert your family challenge</h4>
            <form id="sfidaFamigliareForm" method="post"  class="mt-4">
                {% csrf_token %}
                <div class="mb-3">
                    {{ formSfida.sfidato }}
                </div>
                <div class="mb-4">
                    {{ formSfida.descrizione }}
                </div>
                <div class="mb-4">
                    {{ formSfida.categoria_target }}
                </div>
                <div class="mb-4" >
                <label  style="color: #100d30;padding-bottom:10px">Due date: </label>
                    {{ formSfida.data_scadenza }}
                </div>
                <div style="display: flex; justify-content: center;">
                    <button type="submit" style="background: #00995c; color: white; height: 50px; width: 100px; border-radius: 20px; border: 1px solid #d3d3d3;">Create</button>
                </div>
            </form>
        </div>
    </div>

</section>

<script>
    document.addEventListener("DOMContentLoaded", function() {

        famiglia_id = "{{ famiglia.id }}";
        const contoForm = document.getElementById('contoForm');
        const responseMessage = document.getElementById('responseMessage');
        const contiContainer = document.getElementById('contiContainer');
        const SavingForm = document.getElementById('SavingsPlanModal');
        const SavingsresponseMessage = document.getElementById('SavingsPlanResponseMessage');
        const responseMessageTransaction = document.getElementById('transactionResponseMessage');
        const TransazioneForm = document.getElementById('transactionForm');
        const ChallengeForm  = document.getElementById('sfidaFamigliareForm');
        const respondeMessaggeChallenge = document.getElementById('responseMessageChallenge');
        let currentClickListenerConto;
        let currentClickListenerPianoRisparmio; 
        let currentClickListenerSfida
        transazioni = JSON.parse('{{ transazioni_serializzate|escapejs }}');
        let conti = {{ conti_json|safe }}; 
        let piani_risparmio = {{piani_risparmio_json | safe}};
        let challenge_json = {{challenge_json | safe}};
    
        function reloadPage() {
            location.reload(); 
        }
        
        function deleteConto(contoId) {
            const confirmDelete = confirm('Are you sure you want to delete this account?');
           
            if (confirmDelete) {
                fetch("{% url 'elimina_conto' 0 %}".replace('0', contoId), {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}', 
                    },
                    body: JSON.stringify({})  
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(risposta => {
                    
                    if(risposta.success)
                   
                    reloadPage()
                    })
            
                .catch(error => console.error('Errore durante l\'eliminazione del conto:', error));
            }
        }

        function getCSRFToken() {
            const name = 'csrftoken';
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }
        
       
        function renameConto(contoId) {
            const newName = prompt('Enter the new goal:');
            if (newName) {
                fetch("{% url 'rinomina_conto' 0 'new_name' %}".replace('0', contoId).replace('new_name', encodeURIComponent(newName)), {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()  // Recupera il token CSRF
                    },
                    body: JSON.stringify({
                        'new_name': newName
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        
                        document.getElementById(`contoNome_${contoId}`).textContent = newName;
                        
                        closeButtonDettagliConto = document.getElementById(`closeModelDettagliConto_${contoId}`);
                        if (closeButtonDettagliConto) {
                        closeButtonDettagliConto.addEventListener('click', reloadPage);
                        }
                        alert('The account name has been updated.');
                    } else {
                        alert('Error: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
            } else {
                alert('Account name is not valid.');
            }
        }
        
        const closeModal = (modal) => {
            modal.style.display = 'none';
            contoForm.reset();
            responseMessage.textContent = '';
        };

        contoForm.addEventListener('submit', function(event) {
            event.preventDefault();
            const formData = new FormData(contoForm); 
            const url = "{% url 'createAccountFamily' 0 %}".replace('0', famiglia_id);
          
            fetch(url, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest' // Informa il server che si tratta di una richiesta AJAX
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    
                    const contiElements = document.querySelectorAll('.singolo-conto');
        
                    contiElements.forEach(conto => conto.remove());
                    data.conti.forEach(conto => {
                        const contoDiv = document.createElement('div');
                        contoDiv.className = 'conto-box singolo-conto';
                        contoDiv.id = `singolo_conto_${conto.id}`;
                        contoDiv.style.margin = '10px'; 
                        contoDiv.style.padding = '15px'; 
                        contoDiv.style.borderRadius = '10px';
                        contoDiv.style.color = 'white';
                        contoDiv.style.backgroundColor = '#100d30';
                        contoDiv.style.textAlign = 'left';
                        contoDiv.style.maxHeight = '100px'; 

                        let iconHtml = '';
                        if (conto.tipo === 'corrente') {
                            iconHtml = '<i class="bi bi-bank"></i>';
                        } else if (conto.tipo === 'investimento') {
                            iconHtml = '<i class="bi bi-bar-chart"></i>';
                        } else if (conto.tipo === 'risparmio') {
                            iconHtml = '<i class="bi bi-safe"></i>';
                        } else if (conto.tipo === 'contante') {
                            iconHtml = '<i class="bi bi-cash-coin"></i>';
                        }

                        contoDiv.innerHTML = `${iconHtml}
                            <h3 style="margin-top:5px; color: white; font-size: 18px;">${conto.nome}</h3>
                            <h6 style="color: white; font-size: 14px;">Saldo: ${conto.saldo} €</h6>`;
                        contiContainer.appendChild(contoDiv);
                    });

                   
                    const addButton = document.createElement('div');
                    addButton.id = 'openModalBtn';
                    addButton.className = 'conto-box singolo-conto';
                    addButton.style.borderRadius = '50%';
                    addButton.style.backgroundColor = '#00995c';
                    addButton.style.width = '40px';
                    addButton.style.height = '40px'; 
                    addButton.style.display = 'flex';
                    addButton.style.alignItems = 'center';
                    addButton.style.justifyContent = 'center';
                    addButton.style.marginRight = '15px'; 
                    addButton.style.marginLeft = '15px'; 

                    const addButtonIcon = document.createElement('i');
                    addButtonIcon.className = 'bi bi-plus';
                    addButtonIcon.style.color = 'white';
                    addButtonIcon.style.fontSize = '20px'; 

                    addButton.appendChild(addButtonIcon); 
                    contiContainer.appendChild(addButton);

                    addButton.onclick = function() {
                        const modal = document.getElementById('myModal');
                        modal.style.display = 'block';
                    };

       
                    closeModal(document.getElementById('myModal'));

                } else {
                    let firstField = Object.keys(data.errors)[0]; 
                    responseMessage.textContent = data.errors[firstField][0]; 
                    responseMessage.style.color = 'red';
                    contoForm.reset();
                }
            });
        });

        document.getElementById('openModalBtn').onclick = function() {
            const modal = document.getElementById('myModal');
            responseMessage.textContent = '';
            modal.style.display = 'block';
        };

        
        function handleContoClick(event, dataset) {
           
            if (event.target && event.target.id.startsWith('singolo_conto_')) {
                const contoId = event.target.id.split('_')[2];
                const transazioniDelConto = dataset.filter(transazione => transazione.conto.pk == contoId);
                const NomeConto = (conti.filter(conto => conto.id == contoId))[0]?.nome;
                createModalConto(contoId, transazioniDelConto, NomeConto); // Crea e visualizza il modal per questo conto
            }
        };
        
        function createClickListenerConto(dataset) {
            
            return function(event) {
                handleContoClick(event, dataset);
            };
        };
        
        function addClickListener(dataset) {
           
            const contiContainer = document.getElementById('contiContainer');
        
            // Rimuovi il listener esistente se ce n'è uno
            if (currentClickListenerConto) {
                contiContainer.removeEventListener('click', currentClickListenerConto); 
            }
        
            
            currentClickListenerConto = createClickListenerConto(dataset);
            contiContainer.addEventListener('click', currentClickListenerConto); // Aggiungi il nuovo listener
        };
        

        function updateTransazioni(dataset, newConti) {
            
            conti = newConti; 
            addClickListener(dataset);
        };

        updateTransazioni(transazioni, conti);
    
    
        function createModalConto(contoId, transazioniDelConto, NomeConto) {
            let modal = document.getElementById(`contoModal_${contoId}`);
            if (modal) {
                modal.remove(); // Rimuove il modal esistente dal DOM
            }
           
                modal = document.createElement('div');
                modal.id = `contoModal_${contoId}`;
                modal.classList.add('modal');
                
                // Contenuto dinamico del modal
                modal.innerHTML = `
                        <div class="modal-content" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -80%); z-index: 1000; pointer-events: auto;">
                <button id="closeModelDettagliConto_${contoId}" style="border: none; background: none; font-size: 24px; cursor: pointer; float: right;">&times;</button>
                    <div class="header-row" style="display: flex; align-items: center; padding: 10px 0;">
                        <div style="flex: 1;">
                            <span id="contoNome_${contoId}" style="font-size: 18px; margin-right: 60px; font-weight: bold;">${NomeConto}</span> 
                        </div>
                        <div style="display: flex; align-items: center; margin-left: auto;"> 
                            <i class="bi bi-pencil"id="editContoIcon_${contoId}" style="font-size: 20px; margin-right: 10px; cursor: pointer;"></i> 
                            <i class="bi bi-trash" id="deleteContoIcon_${contoId}"  style="font-size: 20px; cursor: pointer;"></i>
                        </div>
                    </div>

                        
                            <div class="transactions-section">
                                <div id="transactionList_${contoId}" style="max-height: 370px; overflow-y: auto; padding: 10px;">
                                    <!-- Le transazioni saranno caricate qui -->
                                </div>
                                <!-- Paginazione -->
                                <div class="pagination" style="display: flex; justify-content: center; margin-top: 30px;">
                                    <button id="prevPage_${contoId}" class="pagination-btn" style="margin-right: 10px; background: #100d30; color:White; border-radius: 5px;">&laquo; Previous</button>
                                    <button id="nextPage_${contoId}" class="pagination-btn" style= "background: #100d30; color:White; border-radius: 5px;" >Next &raquo;</button>
                                </div>
                            </div>
                        </div>
                    `;
                    
                document.body.appendChild(modal);
                
                const deleteIcon = document.getElementById(`deleteContoIcon_${contoId}`);
                deleteIcon.addEventListener('click', function() {
                    deleteConto(contoId); 
                });

                const editIcon = document.getElementById(`editContoIcon_${contoId}`);

                editIcon.addEventListener('click', function(){
                    renameConto(contoId)
                });
                
                closeButtonDettagliConto = document.getElementById(`closeModelDettagliConto_${contoId}`);
                if (closeButtonDettagliConto) {
                    closeButtonDettagliConto.addEventListener('click', function() {
                        modal = document.getElementById(`contoModal_${contoId}`);
                        if (modal) {
                            modal.style.display = 'none'; // Nasconde il modal impostando display a 'none'
                        }
                    });
                }

                
                loadTransactions(contoId, transazioniDelConto, 1);
            
            
            modal.style.display = 'block';
        };
        
        function loadTransactions(contoId, transazioniDelConto, page) {
            const transactionsPerPage = 10;
            const start = (page - 1) * transactionsPerPage;
            const end = start + transactionsPerPage;
            
            const transactionList = document.getElementById(`transactionList_${contoId}`);
            transactionList.innerHTML = ''; // Pulisce la lista
            
            const pageTransactions = transazioniDelConto.slice(start, end);
             pageTransactions.forEach(transazione => {
                const transactionItem = document.createElement('div');
                transactionItem.style.display = 'flex'; // Usa flexbox per allineare gli elementi
                transactionItem.style.justifyContent = 'space-between'; // Spazia gli elementi
                transactionItem.style.alignItems = 'center'; // Centra verticalmente
            
              
                const transactionText = document.createElement('span');
                
                if(transazione.utente.pk != {{utente.pk}}) {
                    if (transazione.categoria) {
                        if (transazione.tipo === 'trasferimento') {
                            transactionText.textContent = `Category: ${transazione.categoria} | Amount: ${transazione.importo} | Date: ${transazione.data} | Initiator : ${transazione.utente.nome}`;
                        } else {
                            if(transazione.sottocategoria)
                            {
                                if (transazione.descrizione != ''){
                                    transactionText.textContent = `Category: ${transazione.categoria.nome} | Sub-Category: ${transazione.sottocategoria.nome} | Amount: ${transazione.importo} | Date: ${transazione.data} | Description: ${transazione.descrizione} | Initiator : ${transazione.utente.nome}`;
                                    } else {
                                    transactionText.textContent = `Category: ${transazione.categoria.nome} | Sub-Category: ${transazione.sottocategoria.nome} | Amount: ${transazione.importo} | Date: ${transazione.data} | Initiator : ${transazione.utente.nome}`;}
                                    transactionText.style.padding = '5px 0'; // Padding per il testo
                                    transactionItem.appendChild(transactionText);
                            }
                            else
                            {
                                if (transazione.descrizione != ''){
                                    transactionText.textContent = `Category: ${transazione.categoria.nome} | Amount: ${transazione.importo} | Date: ${transazione.data} | Description: ${transazione.descrizione} | Initiator : ${transazione.utente.nome}`;
                                    } else {
                                    transactionText.textContent = `Category: ${transazione.categoria.nome} | Amount: ${transazione.importo} | Date: ${transazione.data} | Initiator : ${transazione.utente.nome}`;}
                                    transactionText.style.padding = '5px 0'; // Padding per il testo
                                    transactionItem.appendChild(transactionText);
                            }
    
                           
                        }
                    } else {
                    if (transazione.tipo === 'trasferimento') {
                        // Se è un trasferimento, utilizza transazione.categoria
                        transactionText.textContent = `Category: null | Amount: ${transazione.importo} | Date: ${transazione.data} | Initiator : ${transazione.utente.nome}`;
                    } else {
                        if (transazione.descrizione != ''){
                        transactionText.textContent = `Category: null | Amount: ${transazione.importo} | Date: ${transazione.data} | Description: ${transazione.descrizione} | Initiator : ${transazione.utente.nome}`;
                        } else {
                        transactionText.textContent = `Category: null | Amount: ${transazione.importo} | Date: ${transazione.data} | Initiator : ${transazione.utente.nome}`;}
                        transactionText.style.padding = '5px 0'; // Padding per il testo
                        transactionItem.appendChild(transactionText);
                    }
                }
                }
                else
                {

                if (transazione.categoria) {
                    if (transazione.tipo === 'trasferimento') {
                        transactionText.textContent = `Category: ${transazione.categoria} | Amount: ${transazione.importo} | Date: ${transazione.data}`;
                    } else {

                        if(transazione.sottocategoria)
                        {
                            if (transazione.descrizione != ''){
                                transactionText.textContent = `Category: ${transazione.categoria.nome} | Sub-Category: ${transazione.sottocategoria.nome} | Amount: ${transazione.importo} | Date: ${transazione.data} | Description: ${transazione.descrizione}`;
                                } else {
                                transactionText.textContent = `Category: ${transazione.categoria.nome} | Sub-Category: ${transazione.sottocategoria.nome} | Amount: ${transazione.importo} | Date: ${transazione.data} `;}
                                transactionText.style.padding = '5px 0'; // Padding per il testo
                                transactionItem.appendChild(transactionText);
                        }
                        else
                        {
                            if (transazione.descrizione != ''){
                                transactionText.textContent = `Category: ${transazione.categoria.nome} | Amount: ${transazione.importo} | Date: ${transazione.data} | Description: ${transazione.descrizione}`;
                                } else {
                                transactionText.textContent = `Category: ${transazione.categoria.nome} | Amount: ${transazione.importo} | Date: ${transazione.data} `;}
                                transactionText.style.padding = '5px 0'; // Padding per il testo
                                transactionItem.appendChild(transactionText);
                        }

                       
                    }
                } 
                else {
                if (transazione.tipo === 'trasferimento') {
                    // Se è un trasferimento, utilizza transazione.categoria
                    transactionText.textContent = `Category: null | Amount: ${transazione.importo} | Date: ${transazione.data}`;
                } else {
                    if (transazione.descrizione != ''){
                    transactionText.textContent = `Category: null | Amount: ${transazione.importo} | Date: ${transazione.data} | Description: ${transazione.descrizione}`;
                    } else {
                    transactionText.textContent = `Category: null | Amount: ${transazione.importo} | Date: ${transazione.data} `;}
                    transactionText.style.padding = '5px 0'; // Padding per il testo
                    transactionItem.appendChild(transactionText);
                }
            }
            }



            if(transazione.utente.pk == {{utente.pk}}) {
                    editIcon = document.createElement('i');
                    editIcon.className = 'bi bi-trash'; 
                    editIcon.style.paddingLeft = '10px'
                    editIcon.style.cursor = 'pointer'; // Mostra il cursore come puntatore
                    editIcon.onclick = () => deleteTransaction(transazione.id, contoId);
                
                    transactionItem.appendChild(editIcon);
                }
                
                    // Aggiungi la transazione alla lista
                    transactionList.appendChild(transactionItem);
                
                    // Aggiungi una linea divisiva
                    const divider = document.createElement('hr');
                    divider.style.margin = '5px 0'; // Spaziatura attorno alla linea divisiva
                    transactionList.appendChild(divider);
                });
                
                // Gestione pagine
                document.getElementById(`prevPage_${contoId}`).onclick = function() {
                    if (page > 1) {
                        loadTransactions(contoId, transazioniDelConto, page - 1);
                    }
                };
                document.getElementById(`nextPage_${contoId}`).onclick = function() {
                    if (end < transazioniDelConto.length) {
                        loadTransactions(contoId, transazioniDelConto, page + 1);
                    }
                };
        };
        
        function deleteConto(contoId) {
            const confirmDelete = confirm('Are you sure you want to delete this account?');
           
            if (confirmDelete) {
                fetch("{% url 'elimina_conto' 0 %}".replace('0', contoId), {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}', 
                    },
                    body: JSON.stringify({})  
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(risposta => {
                    
                    if(risposta.success)
                   
                    reloadPage()
                    })
            
                .catch(error => console.error('Errore durante l\'eliminazione del conto:', error));
            }
        };

        function deletePianoDiRisparmio(pianoId) {
    
                const confirmDelete = confirm('Are you sure you want to delete this saving plan?');
               
                if (confirmDelete) {
                    fetch("{% url 'elimina_piano' 0 %}".replace('0', pianoId), {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}',  // Includi il token CSRF per sicurezza
                        },
                        body: JSON.stringify({})  // Invia un body vuoto (opzionale)
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(risposta => {
                        if(risposta.success)
                       
                        reloadPage()
                        })
                
                    .catch(error => console.error('Errore durante l\'eliminazione del conto:', error));
                }
            
        };
        
        function editPianoDiRisparmio(pianoId, tipo) {
            if(tipo == "scadenza"){
            const newDate = prompt('Enter the new due date (format YYYY-MM-DD):');

            if (newDate && /^\d{4}-\d{2}-\d{2}$/.test(newDate)) {
                const today = new Date();
                const newDateObj = new Date(newDate);
                const oneWeekFromToday = new Date();
                oneWeekFromToday.setDate(today.getDate() + 7);
    
                if (newDateObj <= oneWeekFromToday) {
                    alert("The due date must be at least one week from today.");
                } else {
                    fetch("{% url 'cambia_data_scadenza' 0 'new_date' %}".replace('0', pianoId).replace('new_date', encodeURIComponent(newDate)), {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCSRFToken()  // Recupera il token CSRF
                        },
                        body: JSON.stringify({})
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            

                            
                            document.getElementById(`ScadenzaPiano_${pianoId}`).innerHTML = `<p id="ScadenzaPiano_${pianoId}" style="margin: 0;"><strong>Due date:</strong> ${newDate}</p>`;

                            closeButtonDettagliPiano = document.getElementById(`closeModelDettagliPiano_${pianoId}`);
                            if (closeButtonDettagliPiano) {
                            closeButtonDettagliPiano.addEventListener('click', reloadPage);
                            }
                            alert('The due date has been successfully updated.');
                        } else {
                            alert('Error: ' + data.message);
                        }
                    })
                
                .catch(error => {
                        console.error('Error:', error);
                    });
                }
             } 
             else {
                alert('Invalid date format. Please make sure to use the YYYY-MM-DD format.');
            }
            
    
              
            } else
            {
                const newObbiettivo = prompt('Enter the new goal:');

           
            if (newObbiettivo) {
                if ( newObbiettivo <= 0) {
                    alert("The amount must be positive");
                } else {
                fetch("{% url 'cambia_obbiettivo_piano' 0 'new_obbiettivo' %}".replace('0', pianoId).replace('new_obbiettivo', encodeURIComponent(newObbiettivo)), {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCSRFToken()  // Recupera il token CSRF
                        },
                        body: JSON.stringify({})
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                        
                            document.getElementById(`ObbiettivoPiano_${pianoId}`).innerHTML = `<p id = "ObbiettivoPiano_${pianoId}" style="margin: 0;"><strong>Goal:</strong> €${newObbiettivo}</p>`;

                            closeButtonDettagliPiano = document.getElementById(`closeModelDettagliPiano_${pianoId}`);

                            document.getElementById(`PercentualePiano_${pianoId}`).innerHTML = `<p id = "PercentualePiano_${pianoId}" style="margin: 0;"><strong>Completion percentage:</strong> ${data.percentuale}%</p>`;

                            if (closeButtonDettagliPiano) {
                            closeButtonDettagliPiano.addEventListener('click', reloadPage);
                            }
                            alert('The goal has been successfully updated.');
                        } else 
                            alert('Error: ' + data.message);
                        })
                    .catch(error => {
                        console.error('Error:', error);
                    })
                };
                } 
                }
        };

            
        function createPianoDiRisparmioModal(pianoId, pianoOggetto) {

            let modal = document.getElementById(`pianoModal_${pianoId}`);
            if (modal) {
                modal.remove(); // Rimuove il modal esistente dal DOM
            }
        
            modal = document.createElement('div');
            modal.id = `pianoModal_${pianoId}`;
            modal.classList.add('modal');
        
            // Contenuto dinamico del modal
            modal.innerHTML = `
                                <div class="modal-content" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -80%); z-index: 1000; pointer-events: auto; padding: 20px;">
                        <button id="closeModelDettagliPiano_${pianoId}" style="border: none; background: none; font-size: 24px; cursor: pointer; float: right;">&times;</button>
                        
                        <div class="header-row" style="display: flex; align-items: center; padding: 10px 0; width: 65%;">
                            <div style="flex: 1;">
                                <span id="pianoNome_${pianoId}" style="font-size: 18px; font-weight: bold;">${pianoOggetto.conto}</span>
                            </div>
                            <div style="display: flex; align-items: center; margin-left: auto;">
                                <i class="bi bi-trash" id="deletePianoIcon_${pianoId}" style="font-size: 20px; cursor: pointer;"></i>
                            </div>
                        </div>
                        
                        <div class="details-section" style="padding: 10px; width: 70%;">
                            <!-- Divider -->
                            <div class="divider" style="border-bottom: 1px solid #ddd; margin: 10px 0;"></div>
                            
                            <!-- Obiettivo -->
                            <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                                <p id = "ObbiettivoPiano_${pianoId}" style="margin: 0;"><strong>Goal:</strong> €${pianoOggetto.obbiettivo}</p>
                                <i class="bi bi-pencil" id="editObbiettivo_${pianoId}" style="font-size: 20px; cursor: pointer;"></i>
                            </div>

                            <!-- Divider -->
                            <div class="divider" style="border-bottom: 1px solid #ddd; margin: 10px 0;"></div>

                            <!-- Data di Scadenza -->
                            <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                                <p id = "ScadenzaPiano_${pianoId}" style="margin: 0;"><strong>Due date:</strong> ${pianoOggetto.data_scadenza}</p>
                                <i class="bi bi-pencil" id="editScadenza_${pianoId}" style="font-size: 20px; cursor: pointer;"></i>
                            </div>

                            <!-- Divider -->
                            <div class="divider" style="border-bottom: 1px solid #ddd; margin: 10px 0;"></div>

                            <!-- Data di Creazione -->
                            <p><strong>Creation date:</strong> ${pianoOggetto.data_creazione}</p>

                            <!-- Divider -->
                            <div class="divider" style="border-bottom: 1px solid #ddd; margin: 10px 0;"></div>

                            <!-- Percentuale di Completamento -->
                            <p id = "PercentualePiano_${pianoId}" ><strong>Completion percentage:</strong> ${pianoOggetto.percentuale_completamento}%</p>
                        </div>
                    </div>

                `;
            
                document.body.appendChild(modal);
            
                // Gestione degli eventi per le icone di cancellazione e modifica
                const deleteIcon = document.getElementById(`deletePianoIcon_${pianoId}`);
                deleteIcon.addEventListener('click', function() {
                    deletePianoDiRisparmio(pianoId); // Funzione per eliminare il piano di risparmio
                });
            

                const editScadenza= document.getElementById(`editScadenza_${pianoId}`);
                editScadenza.addEventListener('click', function() {
                    editPianoDiRisparmio(pianoId,"scadenza"); // Funzione per modificare il piano di risparmio
                });
                

                const editObbiettivo = document.getElementById(`editObbiettivo_${pianoId}`);
                editObbiettivo.addEventListener('click', function() {
                    editPianoDiRisparmio(pianoId, "Obbiettivo"); // Funzione per modificare il piano di risparmio
                });

                const closeButtonDettagliPiano = document.getElementById(`closeModelDettagliPiano_${pianoId}`);
                if (closeButtonDettagliPiano) {
                    closeButtonDettagliPiano.addEventListener('click', function() {
                        modal = document.getElementById(`pianoModal_${pianoId}`);
                        if (modal) {
                            modal.style.display = 'none'; // Nasconde il modal impostando display a 'none'
                        }
                    });
                }
            
                modal.style.display = 'block'; // Mostra il modal
        };

        document.getElementById('newSavingPlan').onclick = function() {
                const modal = document.getElementById('SavingsPlanModal');
                responseMessage.textContent = '';
                modal.style.display = 'block';
        };


        const closeModalSavingPlan = (modal) => {
                modal.style.display = 'none';
                document.getElementById('SavingsPlanForm').reset();
                SavingsresponseMessage.textContent = '';
        };

        document.getElementById('SavingsPlanModalExit').onclick = function() {
                const modal = document.getElementById('SavingsPlanModal');
                closeModalSavingPlan(modal); // Chiudi il modale corretto
        };

        document.getElementById('SavingsPlanForm').addEventListener('submit', function(event) {
                event.preventDefault();
                const formData1 = new FormData(this);
                const url1 = "{% url 'createSavingFamily' 0 %}".replace('0', famiglia_id);
                
                fetch(url1, {
                    method: 'POST',
                    body: formData1,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest' // Informa il server che si tratta di una richiesta AJAX
                    }
                })
                .then(
                    response => response.json())
                .then(data => {
                    if (data.success) {
                        // Rimuovi gli elementi esistenti
                        const pianiElements = document.querySelectorAll('.singolo-piano');
                        pianiElements.forEach(piano => piano.remove());
            
                        // Sezione contenitore dove vuoi inserire i nuovi piani di risparmio
                        const container = document.getElementById('pianiContainer'); // Assicurati che esista nel tuo HTML
            
                        // Itera attraverso i dati dei piani ricevuti
                        data.piani_risparmio.forEach(piano => {
                            // Crea il div principale del singolo piano
                            const pianoDiv = document.createElement('div');
                            pianoDiv.classList.add('singolo-piano', 'conto-box');
                            pianoDiv.id=`singolo_piano_${piano.id}`;
                            pianoDiv.style = "margin: 10px; padding: 15px; border-radius: 10px; flex: 0 0 auto; color: white; background-color: #100d30; text-align: center; height: auto; position: relative; width: 30%;";
            
                            // Crea il contenitore del progress circle
                            const progressDiv = document.createElement('div');
                            progressDiv.classList.add('progress-circle');
                            progressDiv.style = "position: relative; display: inline-block; margin-bottom: 10px;";
            
                            // Crea il SVG per la barra di progresso
                            const svg = `
                                <svg viewBox="0 0 36 36" class="circular-chart" style="width: 60px; height: 60px;">
                                    <path class="circle-bg"
                                        d="M18 2.0845
                                            a 15.9155 15.9155 0 0 1 0 31.831
                                            a 15.9155 15.9155 0 0 1 0 -31.831"
                                        fill="none"
                                        stroke="#ddd"
                                        stroke-width="3" />
                                    <path class="circle"
                                        stroke-dasharray="${piano.percentuale_completamento}, 100"
                                        d="M18 2.0845
                                            a 15.9155 15.9155 0 0 1 0 31.831
                                            a 15.9155 15.9155 0 0 1 0 -31.831"
                                        fill="none"
                                        stroke="#00995c"
                                        stroke-width="3"
                                        transform="rotate(180 18 18)" />
                                </svg>
                            `;
                            progressDiv.innerHTML = svg;
            
                            // Crea il logo al centro della barra
                            const logoDiv = document.createElement('div');
                            logoDiv.classList.add('logo');
                            logoDiv.style = "position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);";
                            logoDiv.innerHTML = `<i class="bi bi-safe" style="font-size: 20px;"></i>`;
            
                            // Aggiungi il logo e il progress SVG al div del progress
                            progressDiv.appendChild(logoDiv);
            
                            // Crea il titolo del conto
                            const contoTitle = document.createElement('h3');
                            contoTitle.style = "margin-top: 5px; color: white; font-size: 18px;";
                            contoTitle.innerText = piano.conto;
            
                            // Crea l'elemento per l'obbiettivo del conto
                            const goal = document.createElement('h6');
                            goal.style = "color: white; font-size: 14px;";
                            goal.innerText = `Goal: ${piano.obbiettivo} €`;
            
                            // Crea l'elemento per la data di scadenza
                            const scadenza = document.createElement('h6');
                            scadenza.style = "color: white; font-size: 12px; margin-top: 10px;";
                            scadenza.innerText = piano.data_scadenza;
            
                            // Assembla tutto dentro il div del piano
                            pianoDiv.appendChild(progressDiv);
                            pianoDiv.appendChild(contoTitle);
                            pianoDiv.appendChild(goal);
                            pianoDiv.appendChild(scadenza);
            
                            // Aggiungi il piano al contenitore
                            container.appendChild(pianoDiv);
                        });
                    
                        updatePianiRisparmio(data.piani_risparmio);
                        const modal = document.getElementById('SavingsPlanModal');
                        closeModalSavingPlan(modal);
                    }
                    else {
                        let firstField = Object.keys(data.errors)[0]; 
                        SavingsresponseMessage.textContent = data.errors[firstField][0]; 
                        SavingsresponseMessage.style.color = 'red';
                        document.getElementById('SavingsPlanForm').reset();
                    }
                });
        });

        function handleContoClickPianoRisparmio(event, dataset) {
                if (event.target && event.target.id.startsWith('singolo_piano_')) {
                
                    const pianoId = event.target.id.split('_')[2];
                    const pianoOggetto = dataset.filter(piano => piano.id == pianoId);
                    createPianoDiRisparmioModal(pianoId, pianoOggetto[0]); // Crea e visualizza il modal per questo conto
                };
        };

        function createClickListenerPianiRisparmio(dataset) {
                return function(event) {
                    handleContoClickPianoRisparmio(event, dataset);
                };
        };
            
        function addClickListenerPianiRisparmio(dataset) {
                const pianiContainer = document.getElementById('pianiContainer');
                
                if (currentClickListenerPianoRisparmio) {
                    pianiContainer.removeEventListener('click', currentClickListenerPianoRisparmio); 
                }
            
                
                currentClickListenerPianoRisparmio = createClickListenerPianiRisparmio(dataset);
                pianiContainer.addEventListener('click', currentClickListenerPianoRisparmio); // Aggiungi il nuovo listener
        };
            
        function updatePianiRisparmio(dataset) {
                addClickListenerPianiRisparmio(dataset);
        };

        updatePianiRisparmio(piani_risparmio);
            
            
        function deleteTransaction(transazioneId, contoId) {
                const confirmDelete = confirm('Are you sure you want to delete this transaction?');
            
            
                if (confirmDelete) {
                    fetch("{% url 'elimina_transazione' 0 %}".replace('0', transazioneId), {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}',  // Includi il token CSRF per sicurezza
                        },
                        body: JSON.stringify({})  // Invia un body vuoto (opzionale)
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(transazioniAggiornate => {
                    
                        const transazioniFIltrate = transazioniAggiornate.filter(transazione => transazione.conto_id == contoId);
                        const transactionList = document.getElementById(`transactionList_${contoId}`);
                        transactionList.innerHTML = ''; // Pulisce la lista esistente
                        loadTransactions(contoId, transazioniFIltrate, 1 );
                        closeButtonDettagliConto = document.getElementById(`closeModelDettagliConto_${contoId}`);
                        if (closeButtonDettagliConto) {
                        closeButtonDettagliConto.addEventListener('click', reloadPage);
                        }
                        alert('The transaction has been deleted.');
                        })
                
                    .catch(error => console.error('Errore durante l\'eliminazione della transazione:', error));
                }
        };

        document.getElementById('newTransactionBtn').onclick = function() {
                const modal = document.getElementById('transactionModal');
                responseMessageTransaction.textContent = '';
                modal.style.display = 'block';
        };

        const closeModalTransazione = () => {
                const modal = document.getElementById('transactionModal');
                document.querySelectorAll('.periodica, .investimento, .futura, .delegata, .trasferimento').forEach(function(field) {
                    field.style.display = 'none'; // Nasconde tutti i campi di transazione
                });
                document.querySelectorAll('.singola').forEach(function(field) {
                    field.style.display = 'block'; // Nasconde tutti i campi di transazione
                });
                modal.style.display = 'none';
                responseMessageTransaction.textContent = '';
                TransazioneForm.reset();
        };

        document.getElementById('closeModelTransaction').onclick = function() {
                closeModalTransazione(); 
        };
            
        TransazioneForm.addEventListener('submit', function(event) {
                event.preventDefault();
                const formData = new FormData(TransazioneForm);
                const url = "{% url 'createtransactionFamily' 0 %}".replace('0', famiglia_id);
            
                fetch(url, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest' // Informa il server che si tratta di una richiesta AJAX
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        
                        const contiElements = document.querySelectorAll('.singolo-conto');
                        contiElements.forEach(conto => conto.remove());
                        
                        data.conti.forEach(conto => {
                            const contoDiv = document.createElement('div');
                            contoDiv.className = 'conto-box singolo-conto';
                            contoDiv.id = `singolo_conto_${conto.id}`;
                            contoDiv.style.margin = '10px'; 
                            contoDiv.style.padding = '15px'; 
                            contoDiv.style.borderRadius = '10px';
                            contoDiv.style.color = 'white';
                            contoDiv.style.backgroundColor = '#100d30';
                            contoDiv.style.textAlign = 'left';
                            contoDiv.style.maxHeight = '100px'; 


                            let iconHtml = '';
                            if (conto.tipo === 'corrente') {
                                iconHtml = '<i class="bi bi-bank"></i>';
                            } else if (conto.tipo === 'investimento') {
                                iconHtml = '<i class="bi bi-bar-chart"></i>';
                            } else if (conto.tipo === 'risparmio') {
                                iconHtml = '<i class="bi bi-safe"></i>';
                            } else if (conto.tipo === 'contante') {
                                iconHtml = '<i class="bi bi-cash-coin"></i>';
                            }

                            contoDiv.innerHTML = `${iconHtml}
                                <h3 style="margin-top:5px; color: white; font-size: 18px;">${conto.nome}</h3>
                                <h6 style="color: white; font-size: 14px;">Saldo: ${conto.saldo} €</h6>`;
                            contiContainer.appendChild(contoDiv);
                            
                        });

                        // Per il bottone
                        const addButton = document.createElement('div');
                        addButton.id = 'openModalBtn';
                        addButton.className = 'conto-box singolo-conto';
                        addButton.style.borderRadius = '50%';
                        addButton.style.backgroundColor = '#00995c';
                        addButton.style.width = '40px';
                        addButton.style.height = '40px'; 
                        addButton.style.display = 'flex';
                        addButton.style.alignItems = 'center';
                        addButton.style.justifyContent = 'center';
                        addButton.style.marginRight = '15px'; 
                        addButton.style.marginLeft = '15px'; 

                        const addButtonIcon = document.createElement('i');
                        addButtonIcon.className = 'bi bi-plus';
                        addButtonIcon.style.color = 'white';
                        addButtonIcon.style.fontSize = '20px'; 

                        addButton.appendChild(addButtonIcon); 
                        contiContainer.appendChild(addButton);

                        addButton.onclick = function() {
                            const modal = document.getElementById('myModal');
                            modal.style.display = 'block';
                        };

                        closeModal(document.getElementById('myModal'));
                        
                        closeModalTransazione();

                        
                        
                        
                        updateTransazioni(data.transazioni, data.conti); 

                        let pianiElements = document.querySelectorAll('.singolo-piano');
                        pianiElements.forEach(piano => piano.remove());
            
                        // Sezione contenitore dove vuoi inserire i nuovi piani di risparmio
                        let container = document.getElementById('pianiContainer'); // Assicurati che esista nel tuo HTML
                        
                    
                    
                        data.piani_risparmio.forEach(piano => {
                            
                            const pianoDiv = document.createElement('div');
                            pianoDiv.classList.add('singolo-piano', 'conto-box');
                            pianoDiv.id=`singolo_piano_${piano.id}`;
                            pianoDiv.style = "margin: 10px; padding: 15px; border-radius: 10px; flex: 0 0 auto; color: white; background-color: #100d30; text-align: center; height: auto; position: relative; width: 30%;";
            
                            console.log(pianoDiv);
                            // Crea il contenitore del progress circle
                            const progressDiv = document.createElement('div');
                            progressDiv.classList.add('progress-circle');
                            progressDiv.style = "position: relative; display: inline-block; margin-bottom: 10px;";
            
                            // Crea il SVG per la barra di progresso
                            const svg = `
                                <svg viewBox="0 0 36 36" class="circular-chart" style="width: 60px; height: 60px;">
                                    <path class="circle-bg"
                                        d="M18 2.0845
                                            a 15.9155 15.9155 0 0 1 0 31.831
                                            a 15.9155 15.9155 0 0 1 0 -31.831"
                                        fill="none"
                                        stroke="#ddd"
                                        stroke-width="3" />
                                    <path class="circle"
                                        stroke-dasharray="${piano.percentuale_completamento}, 100"
                                        d="M18 2.0845
                                            a 15.9155 15.9155 0 0 1 0 31.831
                                            a 15.9155 15.9155 0 0 1 0 -31.831"
                                        fill="none"
                                        stroke="#00995c"
                                        stroke-width="3"
                                        transform="rotate(180 18 18)" />
                                </svg>
                            `;
                            progressDiv.innerHTML = svg;
            
                            // Crea il logo al centro della barra
                            const logoDiv = document.createElement('div');
                            logoDiv.classList.add('logo');
                            logoDiv.style = "position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);";
                            logoDiv.innerHTML = `<i class="bi bi-safe" style="font-size: 20px;"></i>`;
            
                            // Aggiungi il logo e il progress SVG al div del progress
                            progressDiv.appendChild(logoDiv);
            
                            // Crea il titolo del conto
                            const contoTitle = document.createElement('h3');
                            contoTitle.style = "margin-top: 5px; color: white; font-size: 18px;";
                            contoTitle.innerText = piano.conto;
            
                            // Crea l'elemento per l'obbiettivo del conto
                            const goal = document.createElement('h6');
                            goal.style = "color: white; font-size: 14px;";
                            goal.innerText = `Goal: ${piano.obbiettivo} €`;
            
                            // Crea l'elemento per la data di scadenza
                            const scadenza = document.createElement('h6');
                            scadenza.style = "color: white; font-size: 12px; margin-top: 10px;";
                            scadenza.innerText = piano.data_scadenza;
            
                            // Assembla tutto dentro il div del piano
                            pianoDiv.appendChild(progressDiv);
                            pianoDiv.appendChild(contoTitle);
                            pianoDiv.appendChild(goal);
                            pianoDiv.appendChild(scadenza);
            
                            // Aggiungi il piano al contenitore
                            container.appendChild(pianoDiv);
                        });

                        updatePianiRisparmio(data.piani_risparmio);

                                                
                        let sfidaElements = document.querySelectorAll('.challenge-bar');
                        sfidaElements.forEach(sfida => sfida.remove());

                        
                        
                        sfidaContainer = document.getElementById('sfidaContainer');

                        
                        while (sfidaContainer.firstChild) {
                            sfidaContainer.removeChild(sfidaContainer.firstChild);
                        }
                    
                        if (data.sfide.length === 0) {
                            
                            const noChallengeMessage = document.createElement('div');
                            noChallengeMessage.className = 'challenge-row';
                            noChallengeMessage.style.cssText = 'display: flex; align-items: center; justify-content: space-between; margin: 10px; padding: 15px; border-radius: 10px; background-color: #100d30; color: white; width: calc(100% - 30px); height: 55px;';
                            
                            const icon = document.createElement('div');
                            icon.className = 'icona-challenge';
                            icon.style.marginRight = '15px';
                            icon.innerHTML = '<i class="bi bi-dash-circle-dotted" style="font-size: 25px; color: white;"></i>';
                    
                            const messageText = document.createElement('div');
                            messageText.className = 'dettagli-challenge';
                            messageText.style.flex = '1';
                            messageText.style.textAlign = 'left';
                            messageText.innerHTML = '<h4 style="margin: 0; font-size: 18px; color: red;">Nessuna sfida disponibile</h4>';
                    
                            noChallengeMessage.appendChild(icon);
                            noChallengeMessage.appendChild(messageText);
                            sfidaContainer.appendChild(noChallengeMessage);
                        } else {
                            // Itera sulle sfide fornite nei dati
                            data.sfide.forEach(sfida => {
                                // Crea il div principale per la riga della sfida
                                const challengeRow = document.createElement('div');
                                challengeRow.className = 'challenge-row';
                                challengeRow.style.cssText = 'display: flex; align-items: center; justify-content: space-between; margin: 10px; padding: 15px; border-radius: 10px; background-color: #100d30; color: white; width: calc(100% - 30px); height: 55px;';
                                
                                // Sfidante a sinistra
                                const sfidanteDiv = document.createElement('div');
                                sfidanteDiv.className = 'sfidante';
                                sfidanteDiv.style.flex = '1';
                                sfidanteDiv.style.textAlign = 'left';
                    
                                const sfidanteName = document.createElement('h3');
                                sfidanteName.style.margin = '0';
                                sfidanteName.style.fontSize = '16px';
                                sfidanteName.style.color = (sfida.importo_sfidante <= sfida.importo_sfidato) ? '#00995c' : 'red';
                                sfidanteName.textContent = sfida.sfidante.nome;
                    
                                const spesaSfidante = document.createElement('p');
                                spesaSfidante.style.margin = '0';
                                spesaSfidante.style.fontSize = '14px';
                                spesaSfidante.style.color = '#ccc';
                                spesaSfidante.textContent = `Spesa: €${sfida.importo_sfidante}`;
                    
                                sfidanteDiv.appendChild(sfidanteName);
                                sfidanteDiv.appendChild(spesaSfidante);
                    
                                // Barra della sfida centrale
                                const challengeBar = document.createElement('div');
                                challengeBar.className = 'challenge-bar';
                                challengeBar.style.cssText = 'display: flex; height: 30px; width: 70%; border: 1px solid #d3d3d3; background-color: #f0f0f0; border-radius: 5px; overflow: hidden; position: relative;';
                                
                                // Condizioni per le percentuali
                                const bar1Color = (sfida.importo_sfidante < sfida.importo_sfidato) ? '#00995c' : 'red';
                                const bar2Color = (sfida.importo_sfidante < sfida.importo_sfidato) ? 'red' : '#00995c';
                    
                                // Crea la prima barra
                                const bar1 = document.createElement('div');
                                bar1.className = 'bar';
                                bar1.style.cssText = `height: 100%; background-color: ${bar1Color}; width: ${sfida.percentuale_sfidante}%;`;
                                
                                // Crea la seconda barra
                                const bar2 = document.createElement('div');
                                bar2.className = 'bar';
                                bar2.style.cssText = `height: 100%; background-color: ${bar2Color}; width: ${sfida.percentuale_sfidato}%;`;
                                
                                challengeBar.appendChild(bar1);
                                challengeBar.appendChild(bar2);
                    
                                // Testo della categoria al centro
                                const categorySpan = document.createElement('span');
                                categorySpan.style.cssText = 'position: absolute; left: 50%; transform: translateX(-50%); color: #333; font-weight: bold;';
                                categorySpan.textContent = sfida.categoria_target.nome;
                                
                                challengeBar.appendChild(categorySpan);
                    
                                // Sfidato a destra
                                const sfidatoDiv = document.createElement('div');
                                sfidatoDiv.className = 'sfidato';
                                sfidatoDiv.style.flex = '1';
                                sfidatoDiv.style.textAlign = 'right';
                    
                                const sfidatoName = document.createElement('h3');
                                sfidatoName.style.margin = '0';
                                sfidatoName.style.fontSize = '16px';
                                sfidatoName.style.color = (sfida.importo_sfidato <= sfida.importo_sfidante) ? '#00995c' : 'red';
                                sfidatoName.textContent = sfida.sfidato.nome;
                    
                                const spesaSfidato = document.createElement('p');
                                spesaSfidato.style.margin = '0';
                                spesaSfidato.style.fontSize = '14px';
                                spesaSfidato.style.color = '#ccc';
                                spesaSfidato.textContent = `Spesa: €${sfida.importo_sfidato}`;
                    
                                sfidatoDiv.appendChild(sfidatoName);
                                sfidatoDiv.appendChild(spesaSfidato);
                    
                                // Aggiungi tutti gli elementi alla riga della sfida
                                challengeRow.appendChild(sfidanteDiv);
                                challengeRow.appendChild(challengeBar);
                                challengeRow.appendChild(sfidatoDiv);
                    
                                // Aggiungi la riga della sfida al contenitore delle sfide
                                sfidaContainer.appendChild(challengeRow);
                            });
                        }
                    
                    } else {
                        let firstField = Object.keys(data.errors)[0];
                        transactionResponseMessage.textContent = data.errors[firstField][0];
                        transactionResponseMessage.style.color = 'red';
                    }
                });
        });


        var tipoDiv = document.getElementById('tipoTra'); 
        if (tipoDiv) {
                var selectElement = tipoDiv.querySelector('select'); // Trova il select all'interno del div
                console.log(selectElement); // Verifica se il select viene correttamente trovato
        
                if (selectElement) {
                    selectElement.addEventListener('change', function() {
                        console.log("Il valore del tipo di transazione è cambiato");
                        var tipoTransazione = this.value; // Ottieni il valore selezionato
                        console.log(tipoTransazione); // Log del valore selezionato
        
                        // Nascondi tutte le descrizioni e i campi di transazione
                        document.querySelectorAll('.descrizione').forEach(function(descrizione) {
                            descrizione.style.display = 'none'; 
                        });
        
                        document.querySelectorAll('.singola, .periodica, .investimento, .futura, .delegata, .trasferimento').forEach(function(field) {
                            field.style.display = 'none'; 
                        });
        
                        // Mostra solo i campi corrispondenti al tipo di transazione
                        if (tipoTransazione === 'singola') {
                            document.querySelectorAll('.singola').forEach(function(singola) {
                                singola.style.display = 'block';  
                            });
                        } else if (tipoTransazione === 'periodica') {
                            document.querySelectorAll('.periodica').forEach(function(periodica) {
                                periodica.style.display = 'block'; 
                            });
                        } else if (tipoTransazione === 'investimento') {
                            document.querySelectorAll('.investimento').forEach(function(investimento) {
                                investimento.style.display = 'block'; 
                            });
                        } else if (tipoTransazione === 'futura') {
                            document.querySelectorAll('.futura').forEach(function(futura) {
                                futura.style.display = 'block'; 
                            });
                        } else if (tipoTransazione === 'delegata') {
                            document.querySelectorAll('.delegata').forEach(function(delegata) {
                                delegata.style.display = 'block'; 
                            });
                        } else if (tipoTransazione === 'trasferimento') {
                            document.querySelectorAll('.trasferimento').forEach(function(trasferimento) {
                                trasferimento.style.display = 'block'; 
                            });
                        }
                    });
                } else {
                    console.log("Il select all'interno del div #tipo non è stato trovato.");
                }
        }

        document.getElementById('newChallenge').onclick = function() {
            const modal = document.getElementById('challengeModal');
            respondeMessaggeChallenge.textContent = '';
            modal.style.display = 'block';
        };

        const closeModalChallenge = () => {
            const modal = document.getElementById('challengeModal');
            modal.style.display = 'none';
            respondeMessaggeChallenge.textContent = '';
            ChallengeForm.reset();
        };

        document.getElementById('closeModelChallenge').onclick = function() {
            closeModalChallenge(); 
        };

        ChallengeForm.addEventListener('submit', function(event) {
            event.preventDefault();
            const formData1 = new FormData(this);
            const url1 = "{% url 'create_challenge' 0 %}".replace('0', famiglia_id);
            
            fetch(url1, {
                method: 'POST',
                body: formData1,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest' // Informa il server che si tratta di una richiesta AJAX
                }
            })
            .then(
                response => response.json())
            .then(data => {
                if (data.valid) {
                    // Rimuovi le sfide esistenti
                    let sfidaElements = document.querySelectorAll('.challenge-row');
                    sfidaElements.forEach(sfida => sfida.remove());
        
                    // Assicurati che il contenitore esista nel tuo HTML
                    let sfidaContainer = document.getElementById('sfidaContainer');
        
                    // Itera sulle nuove sfide fornite nei dati
                    data.sfide.forEach(sfida => {
                        // Crea il div principale per la riga della sfida
                        const challengeRow = document.createElement('div');
                        challengeRow.className = 'challenge-row';
                        challengeRow.style.cssText = 'display: flex; align-items: center; justify-content: space-between; margin: 10px; padding: 15px; border-radius: 10px; background-color: #100d30; color: white; width: calc(100% - 30px); height: 55px;';
                        
                        // Sfidante a sinistra
                        const sfidanteDiv = document.createElement('div');
                        sfidanteDiv.className = 'sfidante';
                        sfidanteDiv.style.flex = '1';
                        sfidanteDiv.style.textAlign = 'left';
        
                        const sfidanteName = document.createElement('h3');
                        sfidanteName.style.margin = '0';
                        sfidanteName.style.fontSize = '18px';
                        sfidanteName.style.color = (sfida.importo_sfidante <= sfida.importo_sfidato) ? '#00995c' : 'red';
                        sfidanteName.textContent = sfida.sfidante.nome;
        
                        const spesaSfidante = document.createElement('p');
                        spesaSfidante.style.margin = '0';
                        spesaSfidante.style.fontSize = '14px';
                        spesaSfidante.style.color = '#ccc';
                        spesaSfidante.textContent = `Spesa: €${sfida.importo_sfidante}`;
        
                        sfidanteDiv.appendChild(sfidanteName);
                        sfidanteDiv.appendChild(spesaSfidante);
        
                        // Barra della sfida centrale
                        const challengeBar = document.createElement('div');
                        challengeBar.className = 'challenge-bar';
                        challengeBar.style.cssText = 'display: flex; height: 30px; width: 70%; border: 1px solid #d3d3d3; background-color: #f0f0f0; border-radius: 5px; overflow: hidden; position: relative;';
                        
                        // Determina i colori delle barre in base alle percentuali
                        const bar1Color = (sfida.importo_sfidante < sfida.importo_sfidato) ? '#00995c' : 'red';
                        const bar2Color = (sfida.importo_sfidante < sfida.importo_sfidato) ? 'red' : '#00995c';
        
                        // Crea la prima barra
                        const bar1 = document.createElement('div');
                        bar1.className = 'bar';
                        bar1.style.cssText = `height: 100%; background-color: ${bar1Color}; width: ${sfida.percentuale_sfidante}%;`;
                        
                        // Crea la seconda barra
                        const bar2 = document.createElement('div');
                        bar2.className = 'bar';
                        bar2.style.cssText = `height: 100%; background-color: ${bar2Color}; width: ${sfida.percentuale_sfidato}%;`;
                        
                        challengeBar.appendChild(bar1);
                        challengeBar.appendChild(bar2);
        
                       
                        const categorySpan = document.createElement('span');
                        categorySpan.style.cssText = 'position: absolute; left: 50%; transform: translateX(-50%); color: #333; font-weight: bold;';
                        categorySpan.textContent = sfida.categoria_target.nome;
                        
                        challengeBar.appendChild(categorySpan);
        
                        
                        const sfidatoDiv = document.createElement('div');
                        sfidatoDiv.className = 'sfidato';
                        sfidatoDiv.style.flex = '1';
                        sfidatoDiv.style.textAlign = 'right';
        
                        const sfidatoName = document.createElement('h3');
                        sfidatoName.style.margin = '0';
                        sfidatoName.style.fontSize = '18px';
                        sfidatoName.style.color = (sfida.importo_sfidato <= sfida.importo_sfidante) ? '#00995c' : 'red';
                        sfidatoName.textContent = sfida.sfidato.nome;
        
                        const spesaSfidato = document.createElement('p');
                        spesaSfidato.style.margin = '0';
                        spesaSfidato.style.fontSize = '14px';
                        spesaSfidato.style.color = '#ccc';
                        spesaSfidato.textContent = `Spesa: €${sfida.importo_sfidato}`;
        
                        sfidatoDiv.appendChild(sfidatoName);
                        sfidatoDiv.appendChild(spesaSfidato);
        
                     
                        challengeRow.appendChild(sfidanteDiv);
                        challengeRow.appendChild(challengeBar);
                        challengeRow.appendChild(sfidatoDiv);
        
                        
                        sfidaContainer.appendChild(challengeRow);
                    });
                    closeModalChallenge()
                } else {
                    let firstFieldErrorKey = Object.keys(data.errors)[0];
                    console.error(data.errors[firstFieldErrorKey][0]); 
                    respondeMessaggeChallenge.textContent = data.errors[firstFieldErrorKey][0];
                }
            });
        });
    
        

        function handleContoClickChallenge(event, dataset) {
            if (event.target && event.target.id.startsWith('singola_sfida_')) {
               
                const ChallengeId = event.target.id.split('_')[2];
                const ChallengeOggetto = dataset.filter(s => s.id == ChallengeId);
                createSfidaFamigliareModal(ChallengeId, ChallengeOggetto[0]); // Crea e visualizza il modal per questo conto
            };
        };

        function createClickListenerChallenge(dataset) {
                return function(event) {
                    handleContoClickChallenge(event, dataset);
                };
        };
            
        function addClickListenerChallenge(dataset) {
                Container = document.getElementById('sfidaContainer');
                
                if (currentClickListenerSfida) {
                    Container.removeEventListener('click', currentClickListenerSfida); 
                }
            
                
                currentClickListenerSfida = createClickListenerChallenge(dataset);
                Container.addEventListener('click', currentClickListenerSfida); // Aggiungi il nuovo listener
        };
            
        function updateChallenge(dataset) {
                addClickListenerChallenge(dataset);
        };

        updateChallenge(challenge_json);

        function deleteSfidaFamigliare(SfidaId) {
   
            const confirmDelete = confirm('Are you sure you want to delete this challenge ?');
           
            if (confirmDelete) {
                fetch("{% url 'elimina_challenge' 0 %}".replace('0', SfidaId), {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}',  // Includi il token CSRF per sicurezza
                    },
                    body: JSON.stringify({})  // Invia un body vuoto (opzionale)
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(risposta => {
                    if(risposta.success)
                    alert(risposta.message)
                    reloadPage()
                    })
            
                .catch(error => console.error('Errore durante l\'eliminazione della challenge:', error));
            }
        
        };
        
        function editChallenge(sfidaId) {
            const newDate = prompt('Enter the new due date (format YYYY-MM-DD):');
            if (newDate && /^\d{4}-\d{2}-\d{2}$/.test(newDate)) {
                const today = new Date();
                const newDateObj = new Date(newDate);
               
                if (newDateObj <= today) {
                    alert("The expiration date cannot be in the past.");
                } else {
                    fetch("{% url 'cambia_data_scadenza_challenge' 0 'new_date' %}".replace('0', sfidaId).replace('new_date', encodeURIComponent(newDate)), {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCSRFToken()  // Recupera il token CSRF
                        },
                        body: JSON.stringify({})
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            document.getElementById(`ScadenzaChallenge_${sfidaId}`).innerHTML = `<p id="ScadenzaChallenge_${sfidaId}" style="margin: 0;"><strong>Due date:</strong> ${newDate}</p>`;
                            closeButtonDettagliChallenge = document.getElementById(`closeModelDettagliSfida_${sfidaId}`);
                            if (closeButtonDettagliChallenge) {
                            closeButtonDettagliChallenge.addEventListener('click', reloadPage);
                            }
                            alert('The due date has been successfully updated.');
                        } else {
                            alert('Error: ' + data.message);
                        }
                    })
                
                .catch(error => {
                        console.error('Error:', error);
                    });
                }
             } 
             else {
                alert('Invalid date format. Please make sure to use the YYYY-MM-DD format.');
            }
            
    
              
            
        };


        function createSfidaFamigliareModal(sfidaId, sfidaOggetto) {

            let modal = document.getElementById(`sfidaModal_${sfidaId}`);
            if (modal) {
                modal.remove(); // Rimuove il modal esistente dal DOM
            }
        
            modal = document.createElement('div');
            modal.id = `sfidaModal_${sfidaId}`;
            modal.classList.add('modal');
        
            // Contenuto dinamico del modal
            modal.innerHTML = `
                <div class="modal-content" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -80%); z-index: 1000; pointer-events: auto; padding: 20px;">
                    <button id="closeModelDettagliSfida_${sfidaId}" style="border: none; background: none; font-size: 24px; cursor: pointer; float: right;">&times;</button>
                    
                    <div class="header-row" style="display: flex; align-items: center; padding: 10px 0; width: 65%;">
                        <div style="flex: 1;">
                            <span id="sfidaDescrizione_${sfidaId}" style="font-size: 18px; font-weight: bold;">${sfidaOggetto.descrizione || "N/A"}</span>
                        </div>
                        <div style="display: flex; align-items: center; margin-left: auto;">
                            <i class="bi bi-trash" id="deleteSfidaIcon_${sfidaId}" style="font-size: 20px; cursor: pointer;"></i>
                        </div>
                    </div>
                    
                    <div class="details-section" style="padding: 10px; width: 70%;">
                        <!-- Divider -->
                        <div class="divider" style="border-bottom: 1px solid #ddd; margin: 10px 0;"></div>
        
                        <!-- Sfidante e Sfidato -->
                        <p><strong>Challenger:</strong> ${sfidaOggetto.sfidante.nome}</p>
                        <p><strong>Challenged:</strong> ${sfidaOggetto.sfidato.nome}</p>
        
                        <!-- Divider -->
                        <div class="divider" style="border-bottom: 1px solid #ddd; margin: 10px 0;"></div>
        
                        <!-- Importo sfidante e sfidato -->
                        <p><strong>Challenger's amount:</strong> €${sfidaOggetto.importo_sfidante}</p>
                        <p><strong>Challenged's amount:</strong> €${sfidaOggetto.importo_sfidato}</p>
        
                        <!-- Divider -->
                        <div class="divider" style="border-bottom: 1px solid #ddd; margin: 10px 0;"></div>

                        

                        <!-- Data di Creazione e Scadenza -->
                        <p><strong>Creation date:</strong> ${sfidaOggetto.data_creazione}</p>
                        <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                        <p id = "ScadenzaChallenge_${sfidaId}" ><strong>Due date:</strong> ${sfidaOggetto.data_scadenza}</p>
                        <i class="bi bi-pencil" id="editScadenza_${sfidaId}" style="font-size: 20px; cursor: pointer;"></i>
                        </div>
        
                        <!-- Divider -->
                        <div class="divider" style="border-bottom: 1px solid #ddd; margin: 10px 0;"></div>
        
                        <!-- Categoria e Famiglia -->
                        <p><strong>Category:</strong> ${sfidaOggetto.categoria_target.nome || "N/A"}</p>
                        
        
                        <!-- Divider -->
                        <div class="divider" style="border-bottom: 1px solid #ddd; margin: 10px 0;"></div>
        
                        <!-- Percentuali di contributo -->
                        <p><strong>Challenger's percentage:</strong> ${sfidaOggetto.percentuale_sfidante}%</p>
                        <p><strong>Challenged's percentage:</strong> ${sfidaOggetto.percentuale_sfidato}%</p>
        
                        <!-- Divider -->
                        <div class="divider" style="border-bottom: 1px solid #ddd; margin: 10px 0;"></div>
        
                        <!-- Stato della sfida -->
                        <p><strong>Challenge status:</strong> Ongoing</p>
                        
                    </div>
                </div>
            `;
        
            document.body.appendChild(modal);
        
            // Gestione degli eventi per l'icona di cancellazione
            const deleteIcon = document.getElementById(`deleteSfidaIcon_${sfidaId}`);
            deleteIcon.addEventListener('click', function() {
                deleteSfidaFamigliare(sfidaId); // Funzione per eliminare la sfida
            });
        
            const closeButtonDettagliSfida = document.getElementById(`closeModelDettagliSfida_${sfidaId}`);
            if (closeButtonDettagliSfida) {
                closeButtonDettagliSfida.addEventListener('click', function() {
                    modal = document.getElementById(`sfidaModal_${sfidaId}`);
                    if (modal) {
                        modal.style.display = 'none'; // Nasconde il modal impostando display a 'none'
                    }
                });
            }

            const editScadenza= document.getElementById(`editScadenza_${sfidaId}`);
            editScadenza.addEventListener('click', function() {
                editChallenge(sfidaId); // Funzione per modificare il piano di risparmio
            });
            
        
            modal.style.display = 'block'; // Mostra il modal
        };
        
        
    
    });
    

    
        


        

        

 </script>

{% endblock content %}