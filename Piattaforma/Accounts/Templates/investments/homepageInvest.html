{% extends "registration/base.html" %}

{% block content %}
  <section id="dashboard" class="sections personal d-flex align-items-start flex-column" style="min-height: 130vh; position: relative;">
    
    <!-- Contenitore dei conti -->
    <div id="contiContainer" class="d-flex flex-wrap" data-aos="fade-up" data-aos-delay="300" style="align-items: center; margin: 60px 30px 5px; justify-content: flex-start; border-radius: 15px; background-color: white; box-shadow: 0 0 18px rgba(0, 0, 0, 0.1); padding: 5px;">
     
      {% if not conti %}
        <div id="conto_esempio" class="singolo-conto conto-box" style="margin: 10px; padding: 15px; border-radius: 10px; background-color: #100d30; color: white; text-align: left;">
            <i class="bi bi-bank"></i>
            <h4 style="margin-top: 5px; color: white;">Account Example</h4>
            <h6 style="color: white;">Balance: 0.00 €</h6>
        </div>
      {% endif %}

      {% for conto in conti %}
        <div id="singolo_conto_{{ conto.id }}" class="singolo-conto conto-box" style="margin: 10px; padding: 15px; border-radius: 10px; background-color: #100d30; color: white; text-align: left;">
          <!-- Icona in base al tipo di conto -->
          {% if conto.tipo == 'corrente' %}
            <i class="bi bi-bank"></i>
          {% elif conto.tipo == 'investimento' %}
            <i class="bi bi-bar-chart"></i>
          {% elif conto.tipo == 'risparmio' %}
            <i class="bi bi-safe"></i>
          {% elif conto.tipo == 'contante' %}
            <i class="bi bi-cash-coin"></i>
          {% endif %}
          <h3 style="margin-top: 5px; font-size: 18px; color: white">{{ conto.nome }}</h3>
          <h6 style="font-size: 14px; color: white">Balance: {{ conto.saldo }} €</h6>
        </div>
      {% endfor %}
    </div>

    <!-- Sezione grafico e pulsante per nuova transazione -->
    <div style="display: flex; justify-content: space-between; width: 100%; margin-top: 20px; padding: 0 30px;">
      <div id="leftDiv" style="flex: 5; margin-right: 30px; padding: 10px; border-radius: 8px; text-align: center;">
        <div class="d-flex flex-wrap" data-aos="fade-up" data-aos-delay="300" style="align-items: center; margin-top: 70px; border-radius: 15px; box-shadow: 0 0 18px rgba(0, 0, 0, 0.1); padding: 10px; background-color: white;">
          <canvas id="saldoChart" width="400" height="300" style="margin: 20px; padding: 10px;"></canvas>
        </div>
      </div>
      
      <div style="padding: 10px; border-radius: 8px; text-align: center;">
        <div class="d-flex flex-wrap" data-aos="fade-up" data-aos-delay="300" style="border-radius: 15px; background-color: white; padding: 10px;">
          <button id="openModalBtn" style="margin: 5px; padding: 10px; border-radius: 8px; border: none; background-color: #00995c; color: white; cursor: pointer; width: 90%;">
            New Transaction
          </button>
        </div>
      </div>
    </div>

    <!-- Modal per nuova transazione -->
    <div id="transactionModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 1000;">
      <div class="modal-content" style="background-color: white; border-radius: 10px; width: 80%; margin: 10% auto; padding: 20px;">
        <button id="closeModalBtn" class="close" style="border: none; background: none; font-size: 24px; cursor: pointer;">&times;</button>
        <div id="searchResponseMessage" style="color: red;"></div>
        <h4 style="color: #100d30;">Search for a Company</h4>
        
        <form id="searchCompanyForm" class="mt-4">
          {% csrf_token %}
          <div class="mb-3">
            <input type="text" id="companyName" name="companyName" placeholder="Enter company name" required style="width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #d3d3d3;">
          </div>
          <div style="display: flex; justify-content: center;">
            <button id="search-button" type="submit" style="background: #00995c; color: white; height: 50px; width: 100px; border-radius: 20px;">Search</button>
          </div>
        </form>

        <!-- Rotella di caricamento -->
        <div id="loadingSpinner" style="display: none; text-align: center; margin-top: 20px">
          <div class="spinner-border text-success" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>

        <!-- Contenitore per i risultati della ricerca -->
        <div id="searchResultsContainer" class="mt-4"></div>
      </div>

      <div id="investimentoModal" class="modal">
        <div class="modal-content" id = "transactionFormDiv">
            <button  id="closeModelTransaction" style="border: none; background: none; font-size: 24px; cursor: pointer; float: right;">&times;</button>
            <div id="transactionResponseMessage" style="color: red; text-align: center; /* Centro il testo */ font-size: 14px; margin-top: 10px;"></div>
            <h4 style="color: #100d30;">Insert your transaction</h4>
            <form id="form" method="post" class="mt-4" >
                {% csrf_token %}
                <div id= "formTransazioneContainer"class="mb-4">
                    {{ formTransazione.conto}}
                </div>
                <div class="mb-4">
                    {{ formTransazione.descrizione}}
                </div>
                <div class="mb-4 investimento" >
                    {{ formTransazione.numero_azioni}}
                </div>
                <div class="mb-4 investimento">
                    {{ formTransazione.prezzo_azione}}
                </div>
                <div style="display: flex; justify-content: center;">
                    <button type="submit" style="background: #00995c; color:white; height: 50px; width: 100px; border-radius: 20px; border: 1px solid #d3d3d3; ">Create</button>
                </div>
                <input type="hidden" name="next" value="{{ next }}">
            </form>
        </div>
    </div>

    </div>


    <!-- Script -->
    <script>
        let nome_azienda;
        let ticker_azienda;
        function addCompany(description, ticker) {
            document.getElementById('investimentoModal').style.display = 'block';
            nome_azienda = description;
            ticker_azienda = ticker;
        }

      document.addEventListener("DOMContentLoaded", function() {
        const searchForm = document.getElementById("searchCompanyForm");
        const resultsContainer = document.getElementById("searchResultsContainer");
        const loadingSpinner = document.getElementById("loadingSpinner");
        const TransazioneForm = document.getElementById('form');
        
        

        var data = {{ data|safe }}.map(Number);  
        var ctx = document.getElementById('saldoChart').getContext('2d');
        var saldoChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: {{ labels|safe }},
            datasets: [{
              data: data,
              fill: true,
              backgroundColor: 'rgba(0, 153, 92, 0.2)',
              borderColor: '#00995c',
              tension: 0.3,
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              title: {
                display: true,
                text: 'Total Balance',
                font: { size: 15, family: 'Arial' },
                color: '#100d30'
              }
            },
            scales: {
              x: { grid: { display: false } },
              y: { grid: { display: true, color: 'rgba(0, 0, 0, 0.1)' } }
            }
          }
        });

        // Gestione del modal
        document.getElementById('openModalBtn').addEventListener('click', function() {
          document.getElementById('transactionModal').style.display = 'block';
        });

        document.getElementById('closeModalBtn').addEventListener('click', function() {
          document.getElementById('transactionModal').style.display = 'none';
        });

        
        // Ricerca azienda con spinner
        searchForm.addEventListener("submit", function(event) {
          event.preventDefault();
          const companyName = document.getElementById("companyName").value;
          
          // Mostra la rotella di caricamento
          loadingSpinner.style.display = 'block';
          resultsContainer.innerHTML = '';  // Resetta i risultati precedenti
          
          fetch(`/dashboard/api/get-company-data/${encodeURIComponent(companyName)}/`)
            .then(response => response.json())
            .then(data => {
              // Nascondi la rotella di caricamento
              loadingSpinner.style.display = 'none';
              resultsContainer.innerHTML = '';

              if (data.error) {
                resultsContainer.innerHTML = `<p style="color:red;">Error: ${data.error}</p>`;
              } else {
                const results = data.result;

                if (results.length === 0) {
                  resultsContainer.innerHTML = `<p style="color:red;">No results found for "${companyName}".</p>`;
                } else {
                    results.forEach(company => {
                        const companyRow = document.createElement("div");
                        companyRow.classList.add("company-result");
                        companyRow.style.cssText = "display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #d3d3d3;";
                        companyRow.innerHTML = `
                          <span>${company.description} (${company.displaySymbol})</span>
                           <button style="background: #00995c; color: white; padding: 5px ; margin-left: 10px; border-radius: 5px; cursor: pointer;" onclick="addCompany('${company.description}', '${company.displaySymbol}')">+</button> `;
                        resultsContainer.appendChild(companyRow);
                      });
                 
                }
              }
            })
            .catch(error => {
              loadingSpinner.style.display = 'none';
              resultsContainer.innerHTML = `<p style="color:red;">An error occurred: ${error.message}</p>`;
            });
        });

        TransazioneForm.addEventListener('submit', function(event) {
            event.preventDefault();
            const formData = new FormData(TransazioneForm);
            console.log(ticker_azienda)
            fetch("{% url 'gestioneInvestimento' 'q' 'z' %}".replace('q', encodeURIComponent(ticker_azienda)).replace('z', encodeURIComponent(nome_azienda)), {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest' // Informa il server che si tratta di una richiesta AJAX
                }
            })
            .then(response => response.json())
            .then(data => {
                console.log("ciao")
                if (data.success) {
                    
                    const contiElements = document.querySelectorAll('.singolo-conto');
                    contiElements.forEach(conto => conto.remove());
                    
                    data.conti.forEach(conto => {
                        const contoDiv = document.createElement('div');
                        contoDiv.className = 'conto-box singolo-conto';
                        contoDiv.id = `singolo_conto_${conto.id}`;
                        contoDiv.style.margin = '10px'; 
                        contoDiv.style.padding = '15px'; 
                        contoDiv.style.borderRadius = '10px';
                        contoDiv.style.color = 'white';
                        contoDiv.style.backgroundColor = '#100d30';
                        contoDiv.style.textAlign = 'left';
                        contoDiv.style.maxHeight = '100px'; 


                        let iconHtml = '';
                        if (conto.tipo === 'corrente') {
                            iconHtml = '<i class="bi bi-bank"></i>';
                        } else if (conto.tipo === 'investimento') {
                            iconHtml = '<i class="bi bi-bar-chart"></i>';
                        } else if (conto.tipo === 'risparmio') {
                            iconHtml = '<i class="bi bi-safe"></i>';
                        } else if (conto.tipo === 'contante') {
                            iconHtml = '<i class="bi bi-cash-coin"></i>';
                        }

                        contoDiv.innerHTML = `${iconHtml}
                            <h3 style="margin-top:5px; color: white; font-size: 18px;">${conto.nome}</h3>
                            <h6 style="color: white; font-size: 14px;">Saldo: ${conto.saldo} €</h6>`;
                        contiContainer.appendChild(contoDiv);
                        
                    });
                    

                    
                    document.getElementById('transactionModal').style.display = 'none';
                    document.getElementById('investimentoModal').style.display = 'none';

                    saldoChart.data.labels = [];  // Svuota le etichette
                    saldoChart.data.datasets[0].data = [];  // Svuota i dati del saldo
                    saldoChart.data.labels = data.labels;  // Imposta le nuove etichette
                    saldoChart.data.datasets[0].data = data.data;  // Imposta i nuovi saldi
                    saldoChart.update();

                } else {
                    let firstField = Object.keys(data.errors)[0];
                    transactionResponseMessage.textContent = data.errors[firstField][0];
                    transactionResponseMessage.style.color = 'red';
                }
            });
        });
       

      });
    </script>
  </section>
{% endblock %}



