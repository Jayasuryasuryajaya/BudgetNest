{% extends "registration/base.html" %}

{% block content %}
  <section id="dashboard" class="sections personal d-flex align-items-start flex-column" style="min-height: 130vh; position: relative;">

    <!--Sezione conti + form conti-->
    <div id="contiContainer" class="d-flex flex-wrap" data-aos="fade-up" data-aos-delay="300" style="align-items: center; margin-top: 60px; margin-left:30px; margin-right:30px; justify-content: flex-start; border-radius: 15px; background-color: white; box-shadow: 0px 0 18px rgba(0, 0, 0, 0.1); max-width: auto; padding-bottom: 5px; padding-top: 5px;">
        {% if not conti %}
        <div id="conto_esempio" class="singolo-conto conto-box" style="margin: 10px; padding: 15px; border-radius: 10px; flex: 0 0 auto; color: white; background-color: #100d30; text-align: left; height: auto;">
            <i class="bi bi-bank"></i>
            <h4 style="margin-top: 5px; color: white;">Account Example</h4>
            <h6 style="color: white;">Balance: 0.00 €</h6>
        </div>
        {% endif %}

        {% for conto in conti %}
            <div id="singolo_conto_{{ conto.id }}" class="singolo-conto conto-box" style="margin: 10px; padding: 15px; border-radius: 10px; flex: 0 0 auto; color: white; background-color: #100d30; text-align: left; height: auto;">
            {% if conto.tipo == 'corrente' %}
                <i class="bi bi-bank"></i>
            {% elif conto.tipo == 'investimento' %}
                <i class="bi bi-bar-chart"></i>
            {% elif conto.tipo == 'risparmio' %}
                <i class="bi bi-safe"></i>
            {% elif conto.tipo == 'contante' %}
                <i class="bi bi-cash-coin"></i>
            {% endif %}
                <h3 style="margin-top:5px; color: white; font-size: 18px;">{{ conto.nome }}</h3> 
            <h6 style="color: white; font-size: 14px;">Balance: {{ conto.saldo }} €</h6>
            </div>
        {% endfor %}

        <div id="openModalBtn" class="singolo-conto conto-box" style="border-radius: 50%; background-color: #00995c; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; margin-right: 15px; margin-left: 15px;">  
        <i class="bi bi-plus" style="color: white; font-size: 20px;"></i> 
        </div>
    </div>

    <!--Sezione grafico + 3 tasti-->
    <div style="display: flex; justify-content: space-between; width: 100%; margin-top: 20px; padding: 0 30px;">
        <div id="leftDiv" style="flex: 4; margin-right: 30px; padding: 10px; border-radius: 8px; text-align: center;">
            <div id="contiContainer" class="d-flex flex-wrap" data-aos="fade-up" data-aos-delay="300" style="align-items: center; margin-top: 70px; margin-left:30px; margin-right:30px; justify-content: flex-start;border-radius: 15px; border: 1px solid #00000; box-shadow: 0px 0 18px rgba(0, 0, 0, 0.1); max-height: auto; padding-bottom: 10px; padding-top: 10px;  background-color: white;">
                <canvas id="saldoChart" width="400" height="300" style = "margin-left:20px; margin-right:20px; margin-bottom:20px;  padding:10px; "  ></canvas>
            </div>
        </div>
        <div id="rightDiv" style="flex: 1; margin-left: 10px; padding: 10px; border-radius: 8px; text-align: center;">
            <div id="contiContainer" class="d-flex flex-wrap" data-aos="fade-up" data-aos-delay="300" style="border-radius: 15px; background-color: white; padding: 10px;">
                <div class="d-flex flex-column" style="align-items: center; width: 100%;">
                    <button id= "newTransactionBtn" style="margin: 5px; padding: 10px 10px; border-radius: 8px; border: none; background-color: #00995c; color: white; cursor: pointer;  width: 90%;">
                        New transaction
                    </button>
                    <button   id= "openSpendingGoalModal" style="margin: 5px; padding: 10px 10px; border-radius: 8px; border: none; background-color: #100d30; color: white; cursor: pointer;  width: 90%;">
                        New spending goal
                    </button>
                    <button id="newSavingPlan" style="margin: 5px; padding: 10px 10px; border-radius: 8px; border: none; background-color: #100d30; color: white; cursor: pointer;  width: 90%;">
                        New savings plan
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Sezione piani risparmio + obbiettivi di spesa + transasioni-->
    <div style="display: flex; justify-content: space-between; width: 100%; margin-top: 20px; padding: 0 30px;">
        <div id="leftDiv" style="flex: 4; margin-right: 30px; padding: 10px; border-radius: 8px; text-align: center;">
            <div id="pianiContainer" class="d-flex flex-wrap" data-aos="fade-up" data-aos-delay="300" style="align-items: center; margin-top: 70px; margin-left:30px; margin-right:30px; justify-content: flex-start; border-radius: 15px; background-color: white; border: 1px solid #00000; box-shadow: 0px 0 18px rgba(0, 0, 0, 0.1); max-height: auto; max-width: auto; padding-bottom: 10px; padding-top: 10px">
                {% if not pianiRisparmio %}
                    <div id= "singolo_piano_esempio"  class="singolo-piano conto-box" style="margin: 10px; padding: 15px; border-radius: 10px; flex: 0 0 auto; color: white; background-color: #100d30; text-align: center; height: auto; position: relative; width : 25%"> 
                        <div class="progress-circle" style="position: relative; display: inline-block; margin-bottom: 10px;">
                            <svg viewBox="0 0 36 36" class="circular-chart" style="width: 60px; height: 60px;">
                                <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="#ddd" stroke-width="3" />
                                <path class="circle" stroke-dasharray=" 70, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="#00995c" stroke-width="3" transform="rotate(180 18 18)"/>
                            </svg>
                        
                            <div class="logo" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
                                <i class="bi bi-safe" style="font-size: 20px;"></i>
                            </div>
                        </div>
                        <h4 style="margin-top: 5px; color: white; font-size: 18px;">Saving Plan Example</h3>
                        <h6 style="color: white; font-size: 14px;">Goal: XXXX €</h6>
                        <h6 style="color: white; font-size: 12px;  margin-top: 10px;">Due date :  YYYY-MM-DD</h6>
                    </div>
                {% endif %}

                {% for piano in pianiRisparmio %}
                    <div  id= "singolo_piano_{{ piano.id }}" class="singolo-piano conto-box" style="margin: 10px; padding: 15px; border-radius: 10px; flex: 0 0 auto; color: white; background-color: #100d30; text-align: center; height: auto; position: relative; width : 29.5%">
                        <div class="progress-circle" style="position: relative; display: inline-block; margin-bottom: 10px;">
                            <svg viewBox="0 0 36 36" class="circular-chart" style="width: 60px; height: 60px;">
                                <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="#ddd" stroke-width="3" />
                                <path class="circle"  stroke-dasharray=" {{piano.percentuale_completamento }}, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="#00995c" stroke-width="3" transform="rotate(180 18 18)"/>
                            </svg>
                            
                            <div class="logo" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
                                <i class="bi bi-safe" style="font-size: 20px;"></i>
                            </div>
                        </div>
                    
                        <h3 style="margin-top: 5px; color: white; font-size: 18px;">{{ piano.conto }}</h3>
                        <h6 style="color: white; font-size: 14px;">Goal: {{ piano.obbiettivo }} €</h6>
                        <h6 style="color: white; font-size: 12px;  margin-top: 10px;"> {{ piano.data_scadenza }} €</h6>
                     </div>
                
                {% endfor %}
            </div>    
        </div>

        <div id="rightDiv" style="flex: 4; margin-left: 10px; padding: 10px; border-radius: 8px; text-align: center;">
            <div id="ObbiettiviContainer" class="d-flex flex-wrap" data-aos="fade-up" data-aos-delay="300" style="border-radius: 15px; background-color: white; padding: 10px;">
                {% if not lista_obbiettivi_spesa %} 
                    <div id="obbiettivoSpesa_esempio" class="piano-spesa conto-box" style="display: flex; align-items: center; justify-content: space-between; margin: 10px; padding: 15px; border-radius: 10px; background-color: #100d30; color: white; width: calc(100% - 20px);">
                        <div class="categoria-target" style="flex: 1; text-align: left;">
                            <h4 style="margin: 0; font-size: 18px; color: white">Spending Goal Example</h3>
                        </div>
                        <div class="progress-bar-container" style="flex: 2; margin: 0 20px; position: relative;">
                            <div class="progress-bar-bg" style="background-color: #ddd; border-radius: 5px; height: 20px; width: 100%;">
                                <div class="progress-bar" style="width: {{ 50 }}%; background-color: red; height: 100%; border-radius: 5px;">
                                </div>
                            </div>  
                        </div>
                        <div class="data-scadenza" style="flex: 1;  text-align: right; ">
                            <h6 style="margin: 0; font-size: 14px; color: white;">Due Date:  YYYY-MM-DD</h6>
                        </div>
                    </div>
                {% else %}
                    {% for obbiettivo in lista_obbiettivi_spesa %}
                        <div id="obbiettivoSpesa_{{obbiettivo.id}}" class="piano-spesa conto-box" style="display: flex; align-items: center; justify-content: space-between; margin: 10px; padding: 15px; border-radius: 10px; background-color: #100d30; color: white; width: calc(100% - 20px);">
                            <div class="categoria-target" style="flex: 1; text-align: left;">
                                <h3 style="margin: 0; font-size: 18px; color: white">{{ obbiettivo.categoria_target }}</h3>
                            </div>
                             <div class="progress-bar-container" style="flex: 2; margin: 0 20px; position: relative;">
                                <div class="progress-bar-bg" style="background-color: #ddd; border-radius: 5px; height: 20px; width: 100%;">
                                    <div class="progress-bar" style="width: {{ obbiettivo.percentuale_completamento }}%; background-color: red; height: 100%; border-radius: 5px;">
                                    </div>
                                </div>
                             </div>
                            <div class="data-scadenza" style="flex: 1;  text-align: right; ">
                                <h6 style="margin: 0; font-size: 14px; color: white;">{{ obbiettivo.data_scadenza }}</h6>
                            </div>
                        </div>
                    {% endfor %}
                {% endif %}
            </div>
            <div id="transazioniContainer" class="d-flex flex-wrap" data-aos="fade-up" data-aos-delay="300" style="border-radius: 15px;margin-left: auto; margin-right: auto; background-color: white; padding: 10px; margin-top: 50px; width: 70%">
                {% if not transazioni %}
                    <div class="transazione-box" style="display: flex; align-items: center; justify-content: space-between; margin: 10px; padding: 15px; border-radius: 10px; background-color: #100d30; color: white; width: calc(100% - 30px); height:55px">
                        <div class="icona-transazione" style="margin-right: 15px;">
                            <i class="bi bi-dash-circle-dotted" style="font-size: 25 px; color: white;"></i>
                        </div>
                        <div class="dettagli-transazione" style="flex: 1; text-align: left;">
                             <h4 style="margin: 0; font-size: 18px; color: red;">Transaction Example</h4>
                            <p style="margin: 0; font-size: 14px; color: #ccc;">Account : X</p>
                        </div>
                    </div>
                {% else %}
                    {% if conteggio_odierne < 5 %}
                        {% for t in transazioni|slice:":5" %}
                            <div class="transazione-box" style="display: flex; align-items: center; justify-content: space-between; margin: 10px; padding: 15px; border-radius: 10px; background-color: #100d30; color: white; width: calc(100% - 30px); height:55px">
                                <div class="icona-transazione" style="margin-right: 15px;">
                                    {% if t.importo > 0 %}
                                        <i class="bi bi-plus-circle-dotted" style="font-size: 25 px; color: white;"></i>
                                    {% else %}
                                        <i class="bi bi-dash-circle-dotted" style="font-size: 25 px; color: white;"></i>
                                    {% endif %}
                                </div>
                                <div class="dettagli-transazione" style="flex: 1; text-align: left;">
                                    {% if t.tipo_transazione == 'trasferimento' %}
                                        <h3 style="margin: 0; font-size: 18px; color: #00995c;">Transfer</h3>
                                        <p style="margin: 0; font-size: 14px; color: #ccc;">{{ t.conto }} -> {{ t.conto_arrivo }}</p>
                                    {% else %}
                                        {% if t.importo >= 0 %}
                                        <h3 style="margin: 0; font-size: 18px; color: #00995c;">{{ t.categoria }} | {{ t.sotto_categoria.nome }}</h3>
                                        {% else %}
                                            <h3 style="margin: 0; font-size: 18px; color: red;">{{ t.categoria }} | {{ t.sotto_categoria.nome }}</h3>
                                        {% endif %}
                                        <p style="margin: 0; font-size: 14px; color: #ccc;">{{ t.conto }}</p>
                                    {% endif %}
                                </div>
                                <div class="importo-transazione" style="flex: 1; text-align: right;">
                                    <h3 style="margin: 0; font-size: 18px; color: white;">€ {{ t.importo }}</h3>
                                    <p style="margin: 0; font-size: 14px; color: #ccc;">{{ t.data }}</p>
                                </div>    
                            </div>
                        {% endfor %}
                    {% else %}
                        {% for t in transazioni_odierne %}
                            <div class="transazione-box" style="display: flex; align-items: center; justify-content: space-between; margin: 10px; padding: 15px; border-radius: 10px; background-color: #100d30; color: white; width: calc(100% - 30px); height:55px">
                                <div class="icona-transazione" style="margin-right: 15px;">
                                    {% if t.importo > 0 %}
                                        <i class="bi bi-plus-circle-dotted" style="font-size: 25 px; color: white;"></i>
                                    {% else %}
                                        <i class="bi bi-dash-circle-dotted" style="font-size: 25 px; color: white;"></i>
                                    {% endif %}
                                </div>
                                <div class="dettagli-transazione" style="flex: 1; text-align: left;">
                                    {% if t.tipo_transazione == 'trasferimento' %}
                                        <h3 style="margin: 0; font-size: 18px; color: #00995c;">Transfer</h3>
                                        <p style="margin: 0; font-size: 14px; color: #ccc;">{{ t.conto }} -> {{ t.conto_arrivo }}</p>
                                    {% else %}
                                        {% if t.importo >= 0 %}
                                            <h3 style="margin: 0; font-size: 18px; color: #00995c;">{{ t.categoria }} | {{ t.sotto_categoria.nome }}</h3>
                                        {% else %}
                                            <h3 style="margin: 0; font-size: 18px; color: red;">{{ t.categoria }} | {{ t.sotto_categoria.nome }}</h3>
                                        {% endif %}
                                        <p style="margin: 0; font-size: 14px; color: #ccc;">{{ t.conto }}</p>
                                    {% endif %}
                                </div>
                                 <div class="importo-transazione" style="flex: 1; text-align: right;">
                                    <h3 style="margin: 0; font-size: 18px; color: white;">€ {{ t.importo }}</h3>
                                    <p style="margin: 0; font-size: 14px; color: #ccc;">{{ t.data }}</p>
                                </div>
                            </div>
                        {% endfor %} 
                    {% endif %}
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Modale per il nuovo conto-->
    <div id="myModal" class="modal">   
        <div class="modal-content">
            <button class="close" style="border: none; background: none; font-size: 24px; cursor: pointer;">&times;</button>
            <div id="responseMessage" style="color: red;"></div>
            <h4 class = "color:#100d30 ">Insert your bank account</h4>
            <form id="contoForm" method="post" action="{% url 'SezionePersonale' %}" class="mt-4">
                {% csrf_token %}
                <div class="mb-3">
                    {{ form.nome }}
                </div>
                <div class="mb-4">
                    {{ form.saldo }}
                </div>
                <div class="mb-4">
                    {{ form.tipo }}
                </div>
                <div style="display: flex; justify-content: center;">
                    <button type="submit" style="background: #00995c; color:white; height: 50px; width: 100px; border-radius: 20px;  border: 1px solid #d3d3d3;">Create</button>
                </div>
                <input type="hidden" name="next" value="{{ next }}">
            </form>
        </div>
    </div>
    
    <!-- Modale per la nuova transazione -->
    <div id="transactionModal" class="modal">
        <div class="modal-content" id = "transactionFormDiv">
            <button  id="closeModelTransaction" style="border: none; background: none; font-size: 24px; cursor: pointer; float: right;">&times;</button>
            <div id="transactionResponseMessage" style="color: red; text-align: center; /* Centro il testo */ font-size: 14px; margin-top: 10px;"></div>
            <h4 style="color: #100d30;">Insert your transaction</h4>
            <form id="transactionForm" method="post" class="mt-4" action = "{% url "gestioneTransazione" %}">
                {% csrf_token %}
                <div class="mb-3" id =  "tipo">
                    {{ formTransazione.tipo_transazione }}
                </div>
                <div id= "formTransazioneContainer"class="mb-4">
                    {{ formTransazione.conto}}
                </div>
                <div class="mb-4">
                    {{ formTransazione.importo }}
                </div>
                <div class="mb-4">
                    {{ formTransazione.data}}
                </div>
                <div class="mb-4">
                    {{ formTransazione.descrizione}}
                </div>
                <div class="mb-4 singola periodica delegata futura"  style="display:block;">
                    {{ formTransazione.categoria}}
                </div>
                <div class="mb-4 singola periodica delegata futura "  style="display:block;">
                    {{ formTransazione.sotto_categoria}}
                </div>
                <div class="mb-4 periodica" style="display:none;">
                    {{ formTransazione.tipo_rinnovo}}
                </div>
                <div class="mb-4 investimento"  style="display:none;">
                    {{ formTransazione.ticker}}
                </div>
                <div class="mb-4 investimento"  style="display:none;">
                    {{ formTransazione.numero_azioni}}
                </div>
                <div class="mb-4 investimento"  style="display:none;">
                    {{ formTransazione.prezzo_ordine}}
                </div>
                <div class="mb-4 investimento"  style="display:none;">
                    {{ formTransazione.borsa}}
                </div>
                <div class="mb-4 investimento"  style="display:none;">
                    {{ formTransazione.valuta}}
                </div>
                <div id= "formTransazioneContoArrivo" class="mb-4 trasferimento"  style="display:none;">
                    {{ formTransazione.conto_arrivo}}
                </div>
                <div style="display: flex; justify-content: center;">
                    <button type="submit" style="background: #00995c; color:white; height: 50px; width: 100px; border-radius: 20px; border: 1px solid #d3d3d3; ">Create</button>
                </div>
                <input type="hidden" name="next" value="{{ next }}">
            </form>
        </div>
    </div>

    <!-- Modale per il nuov obbiettivo di spesa-->
    <div id="SpendingGoalModal" class="modal">
        <div class="modal-content" >
            <button id="SpendingGoalModalExit" style="border: none; background: none; font-size: 24px; cursor: pointer; float: right;">&times;</button>
            <div id="SpendingGoalResponseMessage" style="color: red; text-align: center; font-size: 14px; margin-top: 10px;"></div>
            <h4 style="color: #100d30;">Insert your spending goal</h4>
            <form id="SpendingGoalForm" method="post" class="mt-4" action="{% url 'gestioneObbiettivoSpesa' %}">
                {% csrf_token %}
                <div class="mb-3" id="formSpendingGoalContainer">
                    {{ formObbiettivo.importo }}
                </div>
                <label for="id_categoria_target" style="color: #100d30;padding-bottom:10px">Category Target</label>
                <div class="mb-3">
                    {{ formObbiettivo.categoria_target }}
                </div>
                <div class="mb-3">
                    <label for="id_tipo" style="color: #100d30; padding-bottom:10px">Duration</label>
                    {{ formObbiettivo.tipo }}
                </div>
                <div style="display: flex; justify-content: center;">
                    <button type="submit" style="background: #00995c; color: white; height: 50px; width: 100px; border-radius: 20px; border: 1px solid #d3d3d3;">Create</button>
                </div>
                <input type="hidden" name="next" value="{{ next }}">
            </form>
        </div>
    </div>

    <!-- Modale per il piano risparmio-->
    <div id="SavingsPlanModal" class="modal">
            <div class="modal-content" id = "SavingFormDiv">
                <button  id="SavingsPlanModalExit" style="border: none; background: none; font-size: 24px; cursor: pointer; float: right;">&times;</button>
                <div id="SavingsPlanResponseMessage" style="color: red; text-align: center; /* Centro il testo */font-size: 14px; margin-top: 10px;"></div>
                <h4 style="color: #100d30;">Insert your saving plan</h4>
                <form id="SavingsPlanForm" method="post" class="mt-4" action ="{% url 'gestionePianoRisparmio' %}" >
                    {% csrf_token %}
                
                    <div class="mb-3" id =  "tipo">
                        {{ formPiano.obbiettivo }}
                    </div>
                    <div class="mb-3" id =  "tipo">
                        {{ formPiano.data_scadenza }}
                    </div>
                    <div class="mb-3" id =  "formSavingsContainer">
                        <label for="id_tipo" style="color: #100d30; padding-bottom:10px">Choose saving accout</label>
                        {{ formPiano.conto }}
                    </div>
                                
                    <div style="display: flex; justify-content: center;">
                        <button type="submit" style="background: #00995c; color:white; height: 50px; width: 100px; border-radius: 20px; border: 1px solid #d3d3d3; ">Create</button>
                    </div>
                    <input type="hidden" name="next" value="{{ next }}">
                </form>
            </div>
    </div>

   
     




    
</section>
  

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const contoForm = document.getElementById('contoForm');
        const responseMessage = document.getElementById('responseMessage');
        const contiContainer = document.getElementById('contiContainer');
        const TransazioneForm = document.getElementById('transactionForm');
        const responseMessageTransaction = document.getElementById('transactionResponseMessage');
        const responseMessageGoalSpending = document.getElementById('SpendingGoalResponseMessage');
        const SavingForm = document.getElementById('SavingsPlanModal');
        const SavingsresponseMessage = document.getElementById('SavingsPlanResponseMessage');
        const spendingGoalModal = document.getElementById("SpendingGoalModal");
        const spendingGoalModalExit = document.getElementById("SpendingGoalModalExit");
        const openSpendingGoalBtn = document.getElementById("openSpendingGoalModal");
       
        let conti = {{ conti_json|safe }}; 

        let obbiettivi_spesa = {{ obbiettivi_spesa_json | safe }};

        let piani_risparmio = {{piani_risparmio_json | safe}};
       
        transazioni = JSON.parse('{{ transazioni_serializzate|escapejs }}');
        
        console.log(obbiettivi_spesa)

        
     
        var data = {{ data|safe }}.map(Number);  
         

        var ctx = document.getElementById('saldoChart').getContext('2d');
        var saldoChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: {{ labels|safe }},
                datasets: [{
                    data: data,
                    fill: true, 
                    backgroundColor: 'rgba(0, 153, 92, 0.2)', 
                    borderColor: '#00995c', 
                    tension: 0.3,  
                    borderWidth: 2 
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false 
                    },
                    title: {
                        display: true, 
                        text: 'Total Balance',
                        font: {
                            size: 15, 
                            family: 'Arial', 
                        },
                        color: '#100d30', 
                    
                    },
                    background: {
                        color: 'white' 
                    },
                },
                scales: {
                    x: {
                        grid: {
                            display: false, 
                        },
                        title: {
                            display: false,
                        },
                        
                    },
                    y: {
                        grid: {
                            display: true, 
                            color: 'rgba(0, 0, 0, 0.1)'
                        },
                        title: {
                            display: false,
                            text: 'Saldo Totale'
                        }
                    }
                }
            }
        });
    
        function reloadPage() {
            location.reload(); 
        }
        
        function deleteConto(contoId) {
            const confirmDelete = confirm('Are you sure you want to delete this account?');
           
            if (confirmDelete) {
                fetch("{% url 'elimina_conto' 0 %}".replace('0', contoId), {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}', 
                    },
                    body: JSON.stringify({})  
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(risposta => {
                    
                    if(risposta.success)
                   
                    reloadPage()
                    })
            
                .catch(error => console.error('Errore durante l\'eliminazione del conto:', error));
            }
        }

        function getCSRFToken() {
           
            const name = 'csrftoken';
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }
        
       
        function renameConto(contoId) {
            const newName = prompt('Enter the new goal:');
           
            if (newName) {
                fetch("{% url 'rinomina_conto' 0 'new_name' %}".replace('0', contoId).replace('new_name', encodeURIComponent(newName)), {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()  // Recupera il token CSRF
                    },
                    body: JSON.stringify({
                        'new_name': newName
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        
                        
                        document.getElementById(`contoNome_${contoId}`).textContent = newName;
                        
                        closeButtonDettagliConto = document.getElementById(`closeModelDettagliConto_${contoId}`);
                        if (closeButtonDettagliConto) {
                        closeButtonDettagliConto.addEventListener('click', reloadPage);
                        }
                        alert('The account name has been updated.');
                    } else {
                        alert('Error: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
            } else {
                alert('Account name is not valid.');
            }
        }
        
        const closeModal = (modal) => {
            modal.style.display = 'none';
            contoForm.reset();
            responseMessage.textContent = '';
        };

        
        contoForm.addEventListener('submit', function(event) {
            event.preventDefault();

            const formData = new FormData(contoForm); // Crea un oggetto FormData con i dati del form

            fetch(contoForm.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest' // Informa il server che si tratta di una richiesta AJAX
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    
                    const contiElements = document.querySelectorAll('.singolo-conto');
                    document.getElementById('formTransazioneContainer').innerHTML = data.formTransazione;
                    document.getElementById('formTransazioneContoArrivo').innerHTML = data.formContoArrivo;
                    document.getElementById('formSavingsContainer').innerHTML = data.formSavingPlan;
                    contiElements.forEach(conto => conto.remove());
                    data.conti.forEach(conto => {
                        const contoDiv = document.createElement('div');
                        contoDiv.className = 'conto-box singolo-conto';
                        contoDiv.id = `singolo_conto_${conto.id}`;
                        contoDiv.style.margin = '10px'; 
                        contoDiv.style.padding = '15px'; 
                        contoDiv.style.borderRadius = '10px';
                        contoDiv.style.color = 'white';
                        contoDiv.style.backgroundColor = '#100d30';
                        contoDiv.style.textAlign = 'left';
                        contoDiv.style.maxHeight = '100px'; 

                        let iconHtml = '';
                        if (conto.tipo === 'corrente') {
                            iconHtml = '<i class="bi bi-bank"></i>';
                        } else if (conto.tipo === 'investimento') {
                            iconHtml = '<i class="bi bi-bar-chart"></i>';
                        } else if (conto.tipo === 'risparmio') {
                            iconHtml = '<i class="bi bi-safe"></i>';
                        } else if (conto.tipo === 'contante') {
                            iconHtml = '<i class="bi bi-cash-coin"></i>';
                        }

                        contoDiv.innerHTML = `${iconHtml}
                            <h3 style="margin-top:5px; color: white; font-size: 18px;">${conto.nome}</h3>
                            <h6 style="color: white; font-size: 14px;">Saldo: ${conto.saldo} €</h6>`;
                        contiContainer.appendChild(contoDiv);
                    });

                   
                    const addButton = document.createElement('div');
                    addButton.id = 'openModalBtn';
                    addButton.className = 'conto-box singolo-conto';
                    addButton.style.borderRadius = '50%';
                    addButton.style.backgroundColor = '#00995c';
                    addButton.style.width = '40px';
                    addButton.style.height = '40px'; 
                    addButton.style.display = 'flex';
                    addButton.style.alignItems = 'center';
                    addButton.style.justifyContent = 'center';
                    addButton.style.marginRight = '15px'; 
                    addButton.style.marginLeft = '15px'; 

                    const addButtonIcon = document.createElement('i');
                    addButtonIcon.className = 'bi bi-plus';
                    addButtonIcon.style.color = 'white';
                    addButtonIcon.style.fontSize = '20px'; 

                    addButton.appendChild(addButtonIcon); 
                    contiContainer.appendChild(addButton);

                    addButton.onclick = function() {
                        const modal = document.getElementById('myModal');
                        modal.style.display = 'block';
                    };

                    saldoChart.data.labels = [];  // Svuota le etichette
                    saldoChart.data.datasets[0].data = [];  // Svuota i dati del saldo
                    saldoChart.data.labels = data.labels;  // Imposta le nuove etichette
                    saldoChart.data.datasets[0].data = data.data;  // Imposta i nuovi saldi
                    saldoChart.update();
                    
                    updateTransazioni(transazioni, data.conti)
       
                    closeModal(document.getElementById('myModal'));

                } else {
                    let firstField = Object.keys(data.errors)[0]; 
                    responseMessage.textContent = data.errors[firstField][0]; 
                    responseMessage.style.color = 'red';
                    contoForm.reset();
                }
            });
        });

        document.getElementById('openModalBtn').onclick = function() {
            const modal = document.getElementById('myModal');
            responseMessage.textContent = '';
            modal.style.display = 'block';
        };

           
        let currentClickListener; // Variabile per tenere traccia del listener corrente

        function handleContoClick(event, dataset) {
            if (event.target && event.target.id.startsWith('singolo_conto_')) {
                const contoId = event.target.id.split('_')[2];
                const transazioniDelConto = dataset.filter(transazione => transazione.conto.pk == contoId);
                const NomeConto = (conti.filter(conto => conto.id == contoId))[0]?.nome;
                
                createModal(contoId, transazioniDelConto, NomeConto); // Crea e visualizza il modal per questo conto
            }
        }
        
        function createClickListener(dataset) {
            return function(event) {
                handleContoClick(event, dataset);
            };
        }
        
        function addClickListener(dataset) {
            const contiContainer = document.getElementById('contiContainer');
        
            // Rimuovi il listener esistente se ce n'è uno
            if (currentClickListener) {
                contiContainer.removeEventListener('click', currentClickListener); 
            }
        
            
            currentClickListener = createClickListener(dataset);
            contiContainer.addEventListener('click', currentClickListener); // Aggiungi il nuovo listener
        }
        
        function updateTransazioni(dataset, newConti) {
            conti = newConti; // Aggiorna la variabile globale conti
            addClickListener(dataset); // Aggiungi il listener dopo l'aggiornamento
        }
        updateTransazioni(transazioni, conti)
       
        


        
      
        
        


        
        

        function createModal(contoId, transazioniDelConto, NomeConto) {
            let modal = document.getElementById(`contoModal_${contoId}`);
            if (modal) {
                modal.remove(); // Rimuove il modal esistente dal DOM
            }
           
                modal = document.createElement('div');
                modal.id = `contoModal_${contoId}`;
                modal.classList.add('modal');
                
                // Contenuto dinamico del modal
                modal.innerHTML = `
                    <div class="modal-content" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -80%); z-index: 1000; pointer-events: auto;">
            <button id="closeModelDettagliConto_${contoId}" style="border: none; background: none; font-size: 24px; cursor: pointer; float: right;">&times;</button>
                <div class="header-row" style="display: flex; align-items: center; padding: 10px 0;">
                    <div style="flex: 1;">
                        <span id="contoNome_${contoId}" style="font-size: 18px; margin-right: 60px; font-weight: bold;">${NomeConto}</span> 
                    </div>
                    <div style="display: flex; align-items: center; margin-left: auto;"> 
                        <i class="bi bi-pencil"id="editContoIcon_${contoId}" style="font-size: 20px; margin-right: 10px; cursor: pointer;"></i> 
                        <i class="bi bi-trash" id="deleteContoIcon_${contoId}"  style="font-size: 20px; cursor: pointer;"></i>
                    </div>
                </div>

                       
                        <div class="transactions-section">
                            <div id="transactionList_${contoId}" style="max-height: 370px; overflow-y: auto; padding: 10px;">
                                <!-- Le transazioni saranno caricate qui -->
                            </div>
                            <!-- Paginazione -->
                            <div class="pagination" style="display: flex; justify-content: center; margin-top: 30px;">
                                <button id="prevPage_${contoId}" class="pagination-btn" style="margin-right: 10px; background: #100d30; color:White; border-radius: 5px;">&laquo; Previous</button>
                                <button id="nextPage_${contoId}" class="pagination-btn" style= "background: #100d30; color:White; border-radius: 5px;" >Next &raquo;</button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                const deleteIcon = document.getElementById(`deleteContoIcon_${contoId}`);
                deleteIcon.addEventListener('click', function() {
                    deleteConto(contoId); 
                });

                const editIcon = document.getElementById(`editContoIcon_${contoId}`);

                editIcon.addEventListener('click', function(){
                    renameConto(contoId)
                });
                
                closeButtonDettagliConto = document.getElementById(`closeModelDettagliConto_${contoId}`);
                if (closeButtonDettagliConto) {
                    closeButtonDettagliConto.addEventListener('click', function() {
                        modal = document.getElementById(`contoModal_${contoId}`);
                        if (modal) {
                            modal.style.display = 'none'; // Nasconde il modal impostando display a 'none'
                        }
                    });
                }

                
                loadTransactions(contoId, transazioniDelConto, 1);
            
            
            modal.style.display = 'block';
        }
        
        function loadTransactions(contoId, transazioniDelConto, page) {

        
            const transactionsPerPage = 10;
            const start = (page - 1) * transactionsPerPage;
            const end = start + transactionsPerPage;
            
            const transactionList = document.getElementById(`transactionList_${contoId}`);
            transactionList.innerHTML = ''; // Pulisce la lista
            
            const pageTransactions = transazioniDelConto.slice(start, end);
            pageTransactions.forEach(transazione => {
                const transactionItem = document.createElement('div');
                transactionItem.style.display = 'flex'; // Usa flexbox per allineare gli elementi
                transactionItem.style.justifyContent = 'space-between'; // Spazia gli elementi
                transactionItem.style.alignItems = 'center'; // Centra verticalmente
            
               
                const transactionText = document.createElement('span');

                if(transazione.utente.pk != {{utente.pk}}) {
                    if (transazione.categoria) {
                        if (transazione.tipo === 'trasferimento') {
                            transactionText.textContent = `Category: ${transazione.categoria} | Amount: ${transazione.importo} | Date: ${transazione.data} | Initiator : ${transazione.utente.nome}`;
                        } else {
                            if(transazione.sottocategoria)
                            {
                                if (transazione.descrizione != ''){
                                    transactionText.textContent = `Category: ${transazione.categoria.nome} | Sub-Category: ${transazione.sottocategoria.nome} | Amount: ${transazione.importo} | Date: ${transazione.data} | Description: ${transazione.descrizione} | Initiator : ${transazione.utente.nome}`;
                                    } else {
                                    transactionText.textContent = `Category: ${transazione.categoria.nome} | Sub-Category: ${transazione.sottocategoria.nome} | Amount: ${transazione.importo} | Date: ${transazione.data} | Initiator : ${transazione.utente.nome}`;}
                                    transactionText.style.padding = '5px 0'; // Padding per il testo
                                    transactionItem.appendChild(transactionText);
                            }
                            else
                            {
                                if (transazione.descrizione != ''){
                                    transactionText.textContent = `Category: ${transazione.categoria.nome} | Amount: ${transazione.importo} | Date: ${transazione.data} | Description: ${transazione.descrizione} | Initiator : ${transazione.utente.nome}`;
                                    } else {
                                    transactionText.textContent = `Category: ${transazione.categoria.nome} | Amount: ${transazione.importo} | Date: ${transazione.data} | Initiator : ${transazione.utente.nome}`;}
                                    transactionText.style.padding = '5px 0'; // Padding per il testo
                                    transactionItem.appendChild(transactionText);
                            }
    
                           
                        }
                    } else {
                    if (transazione.tipo === 'trasferimento') {
                        // Se è un trasferimento, utilizza transazione.categoria
                        transactionText.textContent = `Category: null | Amount: ${transazione.importo} | Date: ${transazione.data} | Initiator : ${transazione.utente.nome}`;
                    } else {
                        if (transazione.descrizione != ''){
                        transactionText.textContent = `Category: null | Amount: ${transazione.importo} | Date: ${transazione.data} | Description: ${transazione.descrizione} | Initiator : ${transazione.utente.nome}`;
                        } else {
                        transactionText.textContent = `Category: null | Amount: ${transazione.importo} | Date: ${transazione.data} | Initiator : ${transazione.utente.nome}`;}
                        transactionText.style.padding = '5px 0'; // Padding per il testo
                        transactionItem.appendChild(transactionText);
                    }
                }
                }
                else {

                if (transazione.categoria) {
                    if (transazione.tipo === 'trasferimento') {
                        transactionText.textContent = `Category: ${transazione.categoria} | Amount: ${transazione.importo} | Date: ${transazione.data}`;
                    } else {

                        if(transazione.sottocategoria)
                        {
                            if (transazione.descrizione != ''){
                                transactionText.textContent = `Category: ${transazione.categoria.nome} | Sub-Category: ${transazione.sottocategoria.nome} | Amount: ${transazione.importo} | Date: ${transazione.data} | Description: ${transazione.descrizione}`;
                                } else {
                                transactionText.textContent = `Category: ${transazione.categoria.nome} | Sub-Category: ${transazione.sottocategoria.nome} | Amount: ${transazione.importo} | Date: ${transazione.data} `;}
                                transactionText.style.padding = '5px 0'; // Padding per il testo
                                transactionItem.appendChild(transactionText);
                        }
                        else
                        {
                            if (transazione.descrizione != ''){
                                transactionText.textContent = `Category: ${transazione.categoria.nome} | Amount: ${transazione.importo} | Date: ${transazione.data} | Description: ${transazione.descrizione}`;
                                } else {
                                transactionText.textContent = `Category: ${transazione.categoria.nome} | Amount: ${transazione.importo} | Date: ${transazione.data} `;}
                                transactionText.style.padding = '5px 0'; // Padding per il testo
                                transactionItem.appendChild(transactionText);
                        }

                       
                    }
                } else {
                    
                
                
                if (transazione.tipo === 'trasferimento') {
                    // Se è un trasferimento, utilizza transazione.categoria
                    transactionText.textContent = `Category: null | Amount: ${transazione.importo} | Date: ${transazione.data}`;
                } else {
                    if (transazione.descrizione != ''){
                    transactionText.textContent = `Category: null | Amount: ${transazione.importo} | Date: ${transazione.data} | Description: ${transazione.descrizione}`;
                    } else {
                    transactionText.textContent = `Category: null | Amount: ${transazione.importo} | Date: ${transazione.data} `;}
                    transactionText.style.padding = '5px 0'; // Padding per il testo
                    transactionItem.appendChild(transactionText);
                }
            }
        }
           
                if(transazione.utente.pk == {{utente.pk}}) {
                    editIcon = document.createElement('i');
                    editIcon.className = 'bi bi-trash'; 
                    editIcon.style.paddingLeft = '10px'
                    editIcon.style.cursor = 'pointer'; // Mostra il cursore come puntatore
                    editIcon.onclick = () => deleteTransaction(transazione.id, contoId);
                
                    transactionItem.appendChild(editIcon);
                }
                
            
                // Aggiungi la transazione alla lista
                transactionList.appendChild(transactionItem);
            
                // Aggiungi una linea divisiva
                const divider = document.createElement('hr');
                divider.style.margin = '5px 0'; // Spaziatura attorno alla linea divisiva
                transactionList.appendChild(divider);
            });
            
            // Gestione paginea
            document.getElementById(`prevPage_${contoId}`).onclick = function() {
                if (page > 1) {
                    loadTransactions(contoId, transazioniDelConto, page - 1);
                }
            };
            document.getElementById(`nextPage_${contoId}`).onclick = function() {
                if (end < transazioniDelConto.length) {
                    loadTransactions(contoId, transazioniDelConto, page + 1);
                }
            };
        }
        

        function deleteTransaction(transazioneId, contoId) {
            const confirmDelete = confirm('Are you sure you want to delete this transaction?');
           
        
            if (confirmDelete) {
                fetch("{% url 'elimina_transazione' 0 %}".replace('0', transazioneId), {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}',  // Includi il token CSRF per sicurezza
                    },
                    body: JSON.stringify({})  // Invia un body vuoto (opzionale)
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(transazioniAggiornate => {
                   
                    const transazioniFIltrate = transazioniAggiornate.filter(transazione => transazione.conto_id == contoId);
                    const transactionList = document.getElementById(`transactionList_${contoId}`);
                    transactionList.innerHTML = ''; // Pulisce la lista esistente
                    loadTransactions(contoId, transazioniFIltrate, 1 );
                    closeButtonDettagliConto = document.getElementById(`closeModelDettagliConto_${contoId}`);
                    if (closeButtonDettagliConto) {
                    closeButtonDettagliConto.addEventListener('click', reloadPage);
                    }
                    alert('The transaction has been deleted.');
                    })
            
                .catch(error => console.error('Errore durante l\'eliminazione della transazione:', error));
            }
        }
       
       

        document.getElementById('newTransactionBtn').onclick = function() {
            const modal = document.getElementById('transactionModal');
            responseMessageTransaction.textContent = '';
            modal.style.display = 'block';
        };

        const closeModalTransazione = () => {
            const modal = document.getElementById('transactionModal');
            document.querySelectorAll('.periodica, .investimento, .futura, .delegata, .trasferimento').forEach(function(field) {
                field.style.display = 'none'; // Nasconde tutti i campi di transazione
            });
            document.querySelectorAll('.singola').forEach(function(field) {
                field.style.display = 'block'; // Nasconde tutti i campi di transazione
            });
            modal.style.display = 'none';
            responseMessageTransaction.textContent = '';
            TransazioneForm.reset();
        };

        // Aggiungi l'evento click al documento per chiudere il modulo della transazione
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('transactionModal');
            const isClickInside = modal.contains(event.target) || event.target === document.getElementById('newTransactionBtn');

            if (!isClickInside) {
                closeModalTransazione(); // Chiudi il modulo se il click è all'esterno
            }
        });

        // Aggiungi l'evento click al pulsante di chiusura del modale transazione
        document.getElementById('closeModelTransaction').onclick = function() {
            closeModalTransazione(); // Chiudi il modale delle transazioni
        };

       
        TransazioneForm.addEventListener('submit', function(event) {
            event.preventDefault();
            const formData = new FormData(TransazioneForm); // Crea un oggetto FormData con i dati del form

            fetch(TransazioneForm.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest' // Informa il server che si tratta di una richiesta AJAX
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    
                    const contiElements = document.querySelectorAll('.singolo-conto');
                    contiElements.forEach(conto => conto.remove());
                    
                    data.conti.forEach(conto => {
                        const contoDiv = document.createElement('div');
                        contoDiv.className = 'conto-box singolo-conto';
                        contoDiv.id = `singolo_conto_${conto.id}`;
                        contoDiv.style.margin = '10px'; 
                        contoDiv.style.padding = '15px'; 
                        contoDiv.style.borderRadius = '10px';
                        contoDiv.style.color = 'white';
                        contoDiv.style.backgroundColor = '#100d30';
                        contoDiv.style.textAlign = 'left';
                        contoDiv.style.maxHeight = '100px'; 


                        let iconHtml = '';
                        if (conto.tipo === 'corrente') {
                            iconHtml = '<i class="bi bi-bank"></i>';
                        } else if (conto.tipo === 'investimento') {
                            iconHtml = '<i class="bi bi-bar-chart"></i>';
                        } else if (conto.tipo === 'risparmio') {
                            iconHtml = '<i class="bi bi-safe"></i>';
                        } else if (conto.tipo === 'contante') {
                            iconHtml = '<i class="bi bi-cash-coin"></i>';
                        }

                        contoDiv.innerHTML = `${iconHtml}
                            <h3 style="margin-top:5px; color: white; font-size: 18px;">${conto.nome}</h3>
                            <h6 style="color: white; font-size: 14px;">Saldo: ${conto.saldo} €</h6>`;
                        contiContainer.appendChild(contoDiv);
                        
                    });

                    // Per il bottone
                    const addButton = document.createElement('div');
                    addButton.id = 'openModalBtn';
                    addButton.className = 'conto-box singolo-conto';
                    addButton.style.borderRadius = '50%';
                    addButton.style.backgroundColor = '#00995c';
                    addButton.style.width = '40px';
                    addButton.style.height = '40px'; 
                    addButton.style.display = 'flex';
                    addButton.style.alignItems = 'center';
                    addButton.style.justifyContent = 'center';
                    addButton.style.marginRight = '15px'; 
                    addButton.style.marginLeft = '15px'; 

                    const addButtonIcon = document.createElement('i');
                    addButtonIcon.className = 'bi bi-plus';
                    addButtonIcon.style.color = 'white';
                    addButtonIcon.style.fontSize = '20px'; 

                    addButton.appendChild(addButtonIcon); 
                    contiContainer.appendChild(addButton);

                    addButton.onclick = function() {
                        const modal = document.getElementById('myModal');
                        modal.style.display = 'block';
                    };

                    closeModal(document.getElementById('myModal'));
                    
                    closeModalTransazione();

                    
                    
                    
                    updateTransazioni(data.transazioni, data.conti); 

                    let pianiElements = document.querySelectorAll('.singolo-piano');
                    pianiElements.forEach(piano => piano.remove());
        
                    // Sezione contenitore dove vuoi inserire i nuovi piani di risparmio
                    let container = document.getElementById('pianiContainer'); // Assicurati che esista nel tuo HTML
                    
                   
                   
                    data.piani_risparmio.forEach(piano => {
                        
                        const pianoDiv = document.createElement('div');
                        pianoDiv.classList.add('singolo-piano', 'conto-box');
                        pianoDiv.id=`singolo_piano_${piano.id}`;
                        pianoDiv.style = "margin: 10px; padding: 15px; border-radius: 10px; flex: 0 0 auto; color: white; background-color: #100d30; text-align: center; height: auto; position: relative; width: 30%;";
        
                        console.log(pianoDiv);
                        // Crea il contenitore del progress circle
                        const progressDiv = document.createElement('div');
                        progressDiv.classList.add('progress-circle');
                        progressDiv.style = "position: relative; display: inline-block; margin-bottom: 10px;";
        
                        // Crea il SVG per la barra di progresso
                        const svg = `
                            <svg viewBox="0 0 36 36" class="circular-chart" style="width: 60px; height: 60px;">
                                <path class="circle-bg"
                                    d="M18 2.0845
                                        a 15.9155 15.9155 0 0 1 0 31.831
                                        a 15.9155 15.9155 0 0 1 0 -31.831"
                                    fill="none"
                                    stroke="#ddd"
                                    stroke-width="3" />
                                <path class="circle"
                                    stroke-dasharray="${piano.percentuale_completamento}, 100"
                                    d="M18 2.0845
                                        a 15.9155 15.9155 0 0 1 0 31.831
                                        a 15.9155 15.9155 0 0 1 0 -31.831"
                                    fill="none"
                                    stroke="#00995c"
                                    stroke-width="3"
                                    transform="rotate(180 18 18)" />
                            </svg>
                        `;
                        progressDiv.innerHTML = svg;
        
                        // Crea il logo al centro della barra
                        const logoDiv = document.createElement('div');
                        logoDiv.classList.add('logo');
                        logoDiv.style = "position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);";
                        logoDiv.innerHTML = `<i class="bi bi-safe" style="font-size: 20px;"></i>`;
        
                        // Aggiungi il logo e il progress SVG al div del progress
                        progressDiv.appendChild(logoDiv);
        
                        // Crea il titolo del conto
                        const contoTitle = document.createElement('h3');
                        contoTitle.style = "margin-top: 5px; color: white; font-size: 18px;";
                        contoTitle.innerText = piano.conto;
        
                        // Crea l'elemento per l'obbiettivo del conto
                        const goal = document.createElement('h6');
                        goal.style = "color: white; font-size: 14px;";
                        goal.innerText = `Goal: ${piano.obbiettivo} €`;
        
                        // Crea l'elemento per la data di scadenza
                        const scadenza = document.createElement('h6');
                        scadenza.style = "color: white; font-size: 12px; margin-top: 10px;";
                        scadenza.innerText = piano.data_scadenza;
        
                        // Assembla tutto dentro il div del piano
                        pianoDiv.appendChild(progressDiv);
                        pianoDiv.appendChild(contoTitle);
                        pianoDiv.appendChild(goal);
                        pianoDiv.appendChild(scadenza);
        
                        // Aggiungi il piano al contenitore
                        container.appendChild(pianoDiv);
                    });

                    updatePianiRisparmio(data.piani_risparmio);

                    if (data.obbiettivi_spesa.length !== 0) {
                    pianiElements = document.querySelectorAll('.piano-spesa');
                    pianiElements.forEach(piano => piano.remove());
                    }
                    
                  
                    let container2 = document.getElementById('ObbiettiviContainer');
            
                    
        
                    data.obbiettivi_spesa.forEach(obbiettivo => {
                        
                        // Crea il div principale per l'obiettivo di spesa
                        const pianoDiv = document.createElement('div');
                        pianoDiv.classList.add('piano-spesa', 'conto-box');
                        pianoDiv.id = `obbiettivoSpesa_${obbiettivo.id}`; 
                        pianoDiv.style = "display: flex; align-items: center; justify-content: space-between; margin: 10px; padding: 15px; border-radius: 10px; background-color: #100d30; color: white; width: calc(100% - 20px);";
        
                        // Nome della categoria target
                        const categoriaDiv = document.createElement('div');
                        categoriaDiv.classList.add('categoria-target');
                        categoriaDiv.style = "flex: 1; text-align: left;";
                        const categoriaTitle = document.createElement('h3');
                        categoriaTitle.style = "margin: 0; font-size: 18px; color: white;";
                        categoriaTitle.innerText = obbiettivo.categoria_target.nome; // Assicurati che questo campo esista
                        categoriaDiv.appendChild(categoriaTitle);
        
                        // Barra di completamento
                        const progressBarContainer = document.createElement('div');
                        progressBarContainer.classList.add('progress-bar-container');
                        progressBarContainer.style = "flex: 2; margin: 0 20px; position: relative;";
                        const progressBarBg = document.createElement('div');
                        progressBarBg.classList.add('progress-bar-bg');
                        progressBarBg.style = "background-color: #ddd; border-radius: 5px; height: 20px; width: 100%;";
                        const progressBar = document.createElement('div');
                        progressBar.classList.add('progress-bar');
                        progressBar.style = `width: ${obbiettivo.percentuale_completamento}%; background-color: red; height: 100%; border-radius: 5px;`; // Assicurati che questo campo esista
                        progressBarBg.appendChild(progressBar);
                        progressBarContainer.appendChild(progressBarBg);
        
                        // Data di scadenza
                        const scadenzaDiv = document.createElement('div');
                        scadenzaDiv.classList.add('data-scadenza');
                        scadenzaDiv.style = "flex: 1; text-align: right;";
                        const scadenzaTitle = document.createElement('h6');
                        scadenzaTitle.style = "margin: 0; font-size: 14px; color: white;";
                        scadenzaTitle.innerText = obbiettivo.data_scadenza; // Assicurati che questo campo esista
                        scadenzaDiv.appendChild(scadenzaTitle);
        
                        // Assembla tutto dentro il div del piano
                        pianoDiv.appendChild(categoriaDiv);
                        pianoDiv.appendChild(progressBarContainer);
                        pianoDiv.appendChild(scadenzaDiv);
        
                        // Aggiungi il piano al contenitore
                        container2.appendChild(pianoDiv);
                    });
                    

                    if (data.obbiettivi_spesa.length !== 0) {
                        updateObbiettivoSpesa(data.obbiettivi_spesa);
                    }

                    transazioniElements = document.querySelectorAll('.transazione-box');
                    transazioniElements.forEach(piano => piano.remove());
                    

                    container3 = document.getElementById('transazioniContainer');
                    
                    

                    const transazioniOggi = data.transazioni.filter(transazione => {
                        const oggi = new Date().toISOString().split('T')[0]; // Ottieni la data di oggi in formato YYYY-MM-DD
                        return new Date(transazione.data).toISOString().split('T')[0] === oggi;
                    });


            if (transazioniOggi.length < 5) {
                data.transazioni.slice(0, 5).forEach(transazione => {

                    const transazioneBox = document.createElement('div');
                    transazioneBox.className = 'transazione-box';
                    transazioneBox.style.display = 'flex';
                    transazioneBox.style.alignItems = 'center';
                    transazioneBox.style.justifyContent = 'space-between';
                    transazioneBox.style.margin = '10px';
                    transazioneBox.style.padding = '15px';
                    transazioneBox.style.borderRadius = '10px';
                    transazioneBox.style.backgroundColor = '#100d30';
                    transazioneBox.style.color = 'white';
                    transazioneBox.style.width = 'calc(100% - 30px)';
                    transazioneBox.style.height = '55px';

                    // Creare l'icona della transazione
                    const iconaTransazione = document.createElement('div');
                    iconaTransazione.className = 'icona-transazione';
                    iconaTransazione.style.marginRight = '15px';

                    const iconElement = document.createElement('i');
                    if (transazione.importo > 0) {
                        iconElement.className = 'bi bi-plus-circle-dotted';
                    } else {
                        iconElement.className = 'bi bi-dash-circle-dotted';
                    }
                    iconElement.style.fontSize = '25px';
                    iconElement.style.color = 'white';
                    iconaTransazione.appendChild(iconElement);

                    // Creare i dettagli della transazione
                    const dettagliTransazione = document.createElement('div');
                    dettagliTransazione.className = 'dettagli-transazione';
                    dettagliTransazione.style.flex = '1';
                    dettagliTransazione.style.textAlign = 'left';

                    const categoriaH3 = document.createElement('h3');
                    categoriaH3.style.margin = '0';
                    categoriaH3.style.fontSize = '18px';
                    categoriaH3.style.color = transazione.importo >= 0 ? '#00995c' : 'red';
                    categoriaH3.textContent = transazione.tipo_transazione === 'trasferimento' ? 'Transfer' 
                         : transazione.categoria ? `${transazione.categoria.nome} | ${transazione.sottocategoria ? transazione.sottocategoria.nome : ''}` 
                         : 'N/D';
                    const contoP = document.createElement('p');
                    contoP.style.margin = '0';
                    contoP.style.fontSize = '14px';
                    contoP.style.color = '#ccc';
                    if (transazione.tipo_transazione === 'trasferimento') {
                        contoP.textContent = `${transazione.conto.nome} -> ${transazione.conto_arrivo.nome}`;
                    } else {
                        contoP.textContent = transazione.conto.nome;
                    }

                    dettagliTransazione.appendChild(categoriaH3);
                    dettagliTransazione.appendChild(contoP);

                    // Creare l'importo della transazione
                    const importoTransazione = document.createElement('div');
                    importoTransazione.className = 'importo-transazione';
                    importoTransazione.style.flex = '1';
                    importoTransazione.style.textAlign = 'right';

                    const importoH3 = document.createElement('h3');
                    importoH3.style.margin = '0';
                    importoH3.style.fontSize = '18px';
                    importoH3.style.color = 'white';
                    importoH3.textContent = `€ ${transazione.importo}`;

                    const dataP = document.createElement('p');
                    dataP.style.margin = '0';
                    dataP.style.fontSize = '14px';
                    dataP.style.color = '#ccc';
                    dataP.textContent = transazione.data;

                    importoTransazione.appendChild(importoH3);
                    importoTransazione.appendChild(dataP);

                    // Aggiungere tutti i componenti al box della transazione
                    transazioneBox.appendChild(iconaTransazione);
                    transazioneBox.appendChild(dettagliTransazione);
                    transazioneBox.appendChild(importoTransazione);

                    // Aggiungere il box della transazione al contenitore
                    container3.appendChild(transazioneBox);


                });
                
                
               
                } else {
                // Se ci sono 5 o più transazioni, itera su tutte quelle fatte oggi
                transazioniOggi.forEach(transazione => {
                    // Creare un elemento per ogni transazione
                    const transazioneBox = document.createElement('div');
                    transazioneBox.className = 'transazione-box';
                    transazioneBox.style.display = 'flex';
                    transazioneBox.style.alignItems = 'center';
                    transazioneBox.style.justifyContent = 'space-between';
                    transazioneBox.style.margin = '10px';
                    transazioneBox.style.padding = '15px';
                    transazioneBox.style.borderRadius = '10px';
                    transazioneBox.style.backgroundColor = '#100d30';
                    transazioneBox.style.color = 'white';
                    transazioneBox.style.width = 'calc(100% - 30px)';
                    transazioneBox.style.height = '55px';

                    // Creare l'icona della transazione
                    const iconaTransazione = document.createElement('div');
                    iconaTransazione.className = 'icona-transazione';
                    iconaTransazione.style.marginRight = '15px';

                    const iconElement = document.createElement('i');
                    if (transazione.importo > 0) {
                        iconElement.className = 'bi bi-plus-circle-dotted';
                    } else {
                        iconElement.className = 'bi bi-dash-circle-dotted';
                    }
                    iconElement.style.fontSize = '25px';
                    iconElement.style.color = 'white';
                    iconaTransazione.appendChild(iconElement);

                    // Creare i dettagli della transazione
                    const dettagliTransazione = document.createElement('div');
                    dettagliTransazione.className = 'dettagli-transazione';
                    dettagliTransazione.style.flex = '1';
                    dettagliTransazione.style.textAlign = 'left';

                    const categoriaH3 = document.createElement('h3');
                    categoriaH3.style.margin = '0';
                    categoriaH3.style.fontSize = '18px';
                    categoriaH3.style.color = transazione.importo >= 0 ? '#00995c' : 'red';
                    categoriaH3.textContent = transazione.tipo_transazione === 'trasferimento' ? 'Transfer' 
                         : transazione.categoria ? `${transazione.categoria.nome} | ${transazione.sottocategoria ? transazione.sottocategoria.nome : ''}` 
                         : 'N/D';
                    const contoP = document.createElement('p');
                    contoP.style.margin = '0';
                    contoP.style.fontSize = '14px';
                    contoP.style.color = '#ccc';
                    if (transazione.tipo_transazione === 'trasferimento') {
                        contoP.textContent = `${transazione.conto.nome} -> ${transazione.conto_arrivo.nome}`;
                    } else {
                        contoP.textContent = transazione.conto.nome;
                    }

                    dettagliTransazione.appendChild(categoriaH3);
                    dettagliTransazione.appendChild(contoP);

                    // Creare l'importo della transazione
                    const importoTransazione = document.createElement('div');
                    importoTransazione.className = 'importo-transazione';
                    importoTransazione.style.flex = '1';
                    importoTransazione.style.textAlign = 'right';

                    const importoH3 = document.createElement('h3');
                    importoH3.style.margin = '0';
                    importoH3.style.fontSize = '18px';
                    importoH3.style.color = 'white';
                    importoH3.textContent = `€ ${transazione.importo}`;

                    const dataP = document.createElement('p');
                    dataP.style.margin = '0';
                    dataP.style.fontSize = '14px';
                    dataP.style.color = '#ccc';
                    dataP.textContent = transazione.data;

                    importoTransazione.appendChild(importoH3);
                    importoTransazione.appendChild(dataP);

                    // Aggiungere tutti i componenti al box della transazione
                    transazioneBox.appendChild(iconaTransazione);
                    transazioneBox.appendChild(dettagliTransazione);
                    transazioneBox.appendChild(importoTransazione);

                    // Aggiungere il box della transazione al contenitore
                    container3.appendChild(transazioneBox);
                });
            }
            
            

        
            saldoChart.data.labels = [];  // Svuota le etichette
            saldoChart.data.datasets[0].data = [];  // Svuota i dati del saldo

        
            saldoChart.data.labels = data.labels;  // Imposta le nuove etichette
            saldoChart.data.datasets[0].data = data.data;  // Imposta i nuovi saldi
            
            
       
            saldoChart.update();

                } else {
                    let firstField = Object.keys(data.errors)[0];
                    transactionResponseMessage.textContent = data.errors[firstField][0];
                    transactionResponseMessage.style.color = 'red';
                }
            });
        });

        document.getElementById('tipo').addEventListener('change', function() {
            var tipoTransazione = this.querySelector('select').value; // Assicurati di selezionare il valore corretto

            // Nascondi tutte le descrizioni
            document.querySelectorAll('.descrizione').forEach(function(descrizione) {
                descrizione.style.display = 'none'; // Nasconde tutte le descrizioni
            });

            // Nascondi tutti i campi di transazione
            document.querySelectorAll('.singola, .periodica, .investimento, .futura, .delegata').forEach(function(field) {
                field.style.display = 'none'; // Nasconde tutti i campi di transazione
            });

            // Mostra solo la descrizione corrispondente
            if (tipoTransazione === 'singola') {
                document.querySelectorAll('.singola').forEach(function(singola) {
                    singola.style.display = 'block';  
                });
            } else if (tipoTransazione === 'periodica') {
                document.querySelectorAll('.periodica').forEach(function(periodica) {
                    periodica.style.display = 'block'; 
                });
            } else if (tipoTransazione === 'investimento') {
                document.querySelectorAll('.investimento').forEach(function(investimento) {
                    investimento.style.display = 'block'; 
                });
            } else if (tipoTransazione === 'futura') {
                document.querySelectorAll('.futura').forEach(function(futura) {
                    futura.style.display = 'block'; 
                });
            } else if (tipoTransazione === 'delegata') {
                document.querySelectorAll('.delegata').forEach(function(delegata) {
                    delegata.style.display = 'block'; 
                });
            } else if (tipoTransazione === 'trasferimento') {
                document.querySelectorAll('.trasferimento').forEach(function(delegata) {
                    delegata.style.display = 'block'; 
                });
            }
        });



        document.getElementById('newSavingPlan').onclick = function() {
            const modal = document.getElementById('SavingsPlanModal');
            responseMessage.textContent = '';
            modal.style.display = 'block';
        };


        const closeModalSavingPlan = (modal) => {

            modal.style.display = 'none';
            document.getElementById('SavingsPlanForm').reset();
            SavingsresponseMessage.textContent = '';
        };

        document.getElementById('SavingsPlanModalExit').onclick = function() {
            const modal = document.getElementById('SavingsPlanModal');
            closeModalSavingPlan(modal); // Chiudi il modale corretto
        };


        

        

        document.getElementById('SavingsPlanForm').addEventListener('submit', function(event) {
            event.preventDefault();
        
            const formData = new FormData(this); // Crea un oggetto FormData con i dati del form
        
            fetch(document.getElementById('SavingsPlanForm').action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest' // Informa il server che si tratta di una richiesta AJAX
                }
            })
            .then(
                response => response.json())
            .then(data => {
                if (data.success) {
                    // Rimuovi gli elementi esistenti
                    const pianiElements = document.querySelectorAll('.singolo-piano');
                    pianiElements.forEach(piano => piano.remove());
        
                    // Sezione contenitore dove vuoi inserire i nuovi piani di risparmio
                    const container = document.getElementById('pianiContainer'); // Assicurati che esista nel tuo HTML
        
                    // Itera attraverso i dati dei piani ricevuti
                    data.piani_risparmio.forEach(piano => {
                        // Crea il div principale del singolo piano
                        const pianoDiv = document.createElement('div');
                        pianoDiv.classList.add('singolo-piano', 'conto-box');
                        pianoDiv.id=`singolo_piano_${piano.id}`;
                        pianoDiv.style = "margin: 10px; padding: 15px; border-radius: 10px; flex: 0 0 auto; color: white; background-color: #100d30; text-align: center; height: auto; position: relative; width: 30%;";
        
                        // Crea il contenitore del progress circle
                        const progressDiv = document.createElement('div');
                        progressDiv.classList.add('progress-circle');
                        progressDiv.style = "position: relative; display: inline-block; margin-bottom: 10px;";
        
                        // Crea il SVG per la barra di progresso
                        const svg = `
                            <svg viewBox="0 0 36 36" class="circular-chart" style="width: 60px; height: 60px;">
                                <path class="circle-bg"
                                    d="M18 2.0845
                                        a 15.9155 15.9155 0 0 1 0 31.831
                                        a 15.9155 15.9155 0 0 1 0 -31.831"
                                    fill="none"
                                    stroke="#ddd"
                                    stroke-width="3" />
                                <path class="circle"
                                    stroke-dasharray="${piano.percentuale_completamento}, 100"
                                    d="M18 2.0845
                                        a 15.9155 15.9155 0 0 1 0 31.831
                                        a 15.9155 15.9155 0 0 1 0 -31.831"
                                    fill="none"
                                    stroke="#00995c"
                                    stroke-width="3"
                                    transform="rotate(180 18 18)" />
                            </svg>
                        `;
                        progressDiv.innerHTML = svg;
        
                        // Crea il logo al centro della barra
                        const logoDiv = document.createElement('div');
                        logoDiv.classList.add('logo');
                        logoDiv.style = "position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);";
                        logoDiv.innerHTML = `<i class="bi bi-safe" style="font-size: 20px;"></i>`;
        
                        // Aggiungi il logo e il progress SVG al div del progress
                        progressDiv.appendChild(logoDiv);
        
                        // Crea il titolo del conto
                        const contoTitle = document.createElement('h3');
                        contoTitle.style = "margin-top: 5px; color: white; font-size: 18px;";
                        contoTitle.innerText = piano.conto;
        
                        // Crea l'elemento per l'obbiettivo del conto
                        const goal = document.createElement('h6');
                        goal.style = "color: white; font-size: 14px;";
                        goal.innerText = `Goal: ${piano.obbiettivo} €`;
        
                        // Crea l'elemento per la data di scadenza
                        const scadenza = document.createElement('h6');
                        scadenza.style = "color: white; font-size: 12px; margin-top: 10px;";
                        scadenza.innerText = piano.data_scadenza;
        
                        // Assembla tutto dentro il div del piano
                        pianoDiv.appendChild(progressDiv);
                        pianoDiv.appendChild(contoTitle);
                        pianoDiv.appendChild(goal);
                        pianoDiv.appendChild(scadenza);
        
                        // Aggiungi il piano al contenitore
                        container.appendChild(pianoDiv);
                    });
                    updatePianiRisparmio(data.piani_risparmio);
                    const modal = document.getElementById('SavingsPlanModal');
                    closeModalSavingPlan(modal);
                }
                else {
                    let firstField = Object.keys(data.errors)[0]; 
                    SavingsresponseMessage.textContent = data.errors[firstField][0]; 
                    SavingsresponseMessage.style.color = 'red';
                    document.getElementById('SavingsPlanForm').reset();
                }
            });
        });
        
        

        // Funzione per aprire il modal
        function openSpendingGoalModal() {
            spendingGoalModal.style.display = "block";
            document.body.style.overflow = "hidden";  // Evita lo scroll della pagina quando il modal è aperto
        }

        // Funzione per chiudere il modal
        function closeSpendingGoalModal() {
            spendingGoalModal.style.display = "none";
            responseMessageGoalSpending.textContent = "";
            document.getElementById('SpendingGoalForm').reset();
            document.body.style.overflow = "auto";  // Ripristina lo scroll della pagina
        }

        // Quando l'utente clicca sul bottone di apertura
        if (openSpendingGoalBtn) {
            openSpendingGoalBtn.addEventListener("click", openSpendingGoalModal);
        }

        // Quando l'utente clicca sulla 'x' per chiudere
        if (spendingGoalModalExit) {
            spendingGoalModalExit.addEventListener("click", closeSpendingGoalModal);
        }

        // Chiudi il modal se l'utente clicca fuori dal modal stesso
        window.addEventListener("click", function(event) {
            if (event.target === spendingGoalModal) {
                closeSpendingGoalModal();
            }
        })
        



        document.getElementById('SpendingGoalForm').addEventListener('submit', function(event) {
            event.preventDefault(); // Previene il comportamento predefinito del form
           
            const formData = new FormData(this); // Crea un oggetto FormData con i dati del form
        
            fetch(document.getElementById('SpendingGoalForm').action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest' // Indica che si tratta di una richiesta AJAX
                }
            })
            .then(response => {
                
                return response.json();
            })
            .then(data => {
               
                if (data.success) {
                    
                    
                   
                    let pianiElements = document.querySelectorAll('.piano-spesa');
                    pianiElements.forEach(piano => piano.remove());
                    let container = document.getElementById('ObbiettiviContainer'); // Assicurati che esista nel tuo HTML
                    
                    data.obbiettivi_spesa.forEach(obbiettivo => {
                        // Crea il div principale per l'obiettivo di spesa
                        let pianoDiv = document.createElement('div');
                        pianoDiv.id = `obbiettivoSpesa_${obbiettivo.id}`; 
                        pianoDiv.classList.add('piano-spesa', 'conto-box');
                        pianoDiv.style = "display: flex; align-items: center; justify-content: space-between; margin: 10px; padding: 15px; border-radius: 10px; background-color: #100d30; color: white; width: calc(100% - 20px);";
                       
                        console.log(pianoDiv)
                        // Nome della categoria target
                        let categoriaDiv = document.createElement('div');
                        categoriaDiv.classList.add('categoria-target');
                        categoriaDiv.style = "flex: 1; text-align: left;";
                        let categoriaTitle = document.createElement('h3');
                        categoriaTitle.style = "margin: 0; font-size: 18px; color: white;";
                        categoriaTitle.innerText = obbiettivo.categoria_target.nome; // Assicurati che questo campo esista
                        categoriaDiv.appendChild(categoriaTitle);
        
                        // Barra di completamento
                        let progressBarContainer = document.createElement('div');
                        progressBarContainer.classList.add('progress-bar-container');
                        progressBarContainer.style = "flex: 2; margin: 0 20px; position: relative;";
                        let progressBarBg = document.createElement('div');
                        progressBarBg.classList.add('progress-bar-bg');
                        progressBarBg.style = "background-color: #ddd; border-radius: 5px; height: 20px; width: 100%;";
                        let progressBar = document.createElement('div');
                        progressBar.classList.add('progress-bar');
                        progressBar.style = `width: ${obbiettivo.percentuale_completamento}%; background-color: red; height: 100%; border-radius: 5px;`; // Assicurati che questo campo esista
                        progressBarBg.appendChild(progressBar);
                        progressBarContainer.appendChild(progressBarBg);
        
                        // Data di scadenza
                        let scadenzaDiv = document.createElement('div');
                        scadenzaDiv.classList.add('data-scadenza');
                        scadenzaDiv.style = "flex: 1; text-align: right;";
                        let scadenzaTitle = document.createElement('h6');
                        scadenzaTitle.style = "margin: 0; font-size: 14px; color: white;";
                        scadenzaTitle.innerText = obbiettivo.data_scadenza; // Assicurati che questo campo esista
                        scadenzaDiv.appendChild(scadenzaTitle);
        
                        // Assembla tutto dentro il div del piano
                        pianoDiv.appendChild(categoriaDiv);
                        pianoDiv.appendChild(progressBarContainer);
                        pianoDiv.appendChild(scadenzaDiv);
        
                        // Aggiungi il piano al contenitore
                        container.appendChild(pianoDiv);
                    });
                    updateObbiettivoSpesa(data.obbiettivi_spesa);
                    let modal = document.getElementById('SpendingGoalModal');
                    closeSpendingGoalModal(modal);
                } else {
                
                    let firstField = Object.keys(data.errors)[0];
                    responseMessageGoalSpending.textContent = data.errors[firstField][0];
                    responseMessageGoalSpending.style.color = 'red';
                    document.getElementById('SpendingGoalForm').reset();
                   
                }
            });
        });


        let currentClickListenerPianoRisparmio; // Variabile per tenere traccia del listener corrente


        function handleContoClickPianoRisparmio(event, dataset) {
            if (event.target && event.target.id.startsWith('singolo_piano_')) {
               
                const pianoId = event.target.id.split('_')[2];
                const pianoOggetto = dataset.filter(piano => piano.id == pianoId);
                createPianoDiRisparmioModal(pianoId, pianoOggetto[0]); // Crea e visualizza il modal per questo conto
            };
        };

        function createClickListenerPianiRisparmio(dataset) {
            return function(event) {
                handleContoClickPianoRisparmio(event, dataset);
            };
        };
        
        function addClickListenerPianiRisparmio(dataset) {
            const pianiContainer = document.getElementById('pianiContainer');
            
            if (currentClickListenerPianoRisparmio) {
                pianiContainer.removeEventListener('click', currentClickListenerPianoRisparmio); 
            }
        
            
            currentClickListenerPianoRisparmio = createClickListenerPianiRisparmio(dataset);
            pianiContainer.addEventListener('click', currentClickListenerPianoRisparmio); // Aggiungi il nuovo listener
        };
        
        function updatePianiRisparmio(dataset) {
            addClickListenerPianiRisparmio(dataset);
        };

        
        updatePianiRisparmio(piani_risparmio);
       
        





        
        function deletePianoDiRisparmio(pianoId) {
    
                const confirmDelete = confirm('Are you sure you want to delete this saving plan?');
               
                if (confirmDelete) {
                    fetch("{% url 'elimina_piano' 0 %}".replace('0', pianoId), {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}',  // Includi il token CSRF per sicurezza
                        },
                        body: JSON.stringify({})  // Invia un body vuoto (opzionale)
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(risposta => {
                        if(risposta.success)
                       
                        reloadPage()
                        })
                
                    .catch(error => console.error('Errore durante l\'eliminazione del conto:', error));
                }
            
        };
        
        function editPianoDiRisparmio(pianoId, tipo) {
            if(tipo == "scadenza"){
            const newDate = prompt('Enter the new due date (format YYYY-MM-DD):');

            if (newDate && /^\d{4}-\d{2}-\d{2}$/.test(newDate)) {
                const today = new Date();
                const newDateObj = new Date(newDate);
                const oneWeekFromToday = new Date();
                oneWeekFromToday.setDate(today.getDate() + 7);
    
                if (newDateObj <= oneWeekFromToday) {
                    alert("The due date must be at least one week from today.");
                } else {
                    fetch("{% url 'cambia_data_scadenza' 0 'new_date' %}".replace('0', pianoId).replace('new_date', encodeURIComponent(newDate)), {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCSRFToken()  // Recupera il token CSRF
                        },
                        body: JSON.stringify({})
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            

                            
                            document.getElementById(`ScadenzaPiano_${pianoId}`).innerHTML = `<p id="ScadenzaPiano_${pianoId}" style="margin: 0;"><strong>Due date:</strong> ${newDate}</p>`;

                            closeButtonDettagliPiano = document.getElementById(`closeModelDettagliPiano_${pianoId}`);
                            if (closeButtonDettagliPiano) {
                            closeButtonDettagliPiano.addEventListener('click', reloadPage);
                            }
                            alert('The due date has been successfully updated.');
                        } else {
                            alert('Error: ' + data.message);
                        }
                    })
                
                .catch(error => {
                        console.error('Error:', error);
                    });
                }
             } 
             else {
                alert('Invalid date format. Please make sure to use the YYYY-MM-DD format.');
            }
            
    
              
            } else
            {
                const newObbiettivo = prompt('Enter the new goal:');

           
            if (newObbiettivo) {
                if ( newObbiettivo <= 0) {
                    alert("The amount must be positive");
                } else {
                fetch("{% url 'cambia_obbiettivo_piano' 0 'new_obbiettivo' %}".replace('0', pianoId).replace('new_obbiettivo', encodeURIComponent(newObbiettivo)), {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCSRFToken()  // Recupera il token CSRF
                        },
                        body: JSON.stringify({})
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                        
                            document.getElementById(`ObbiettivoPiano_${pianoId}`).innerHTML = `<p id = "ObbiettivoPiano_${pianoId}" style="margin: 0;"><strong>Goal:</strong> €${newObbiettivo}</p>`;

                            closeButtonDettagliPiano = document.getElementById(`closeModelDettagliPiano_${pianoId}`);

                            document.getElementById(`PercentualePiano_${pianoId}`).innerHTML = `<p id = "PercentualePiano_${pianoId}" style="margin: 0;"><strong>Completion percentage:</strong> ${data.percentuale}%</p>`;

                            if (closeButtonDettagliPiano) {
                            closeButtonDettagliPiano.addEventListener('click', reloadPage);
                            }
                            alert('The goal has been successfully updated.');
                        } else 
                            alert('Error: ' + data.message);
                        })
                    .catch(error => {
                        console.error('Error:', error);
                    })
                };
                } 
            }
        };

            
          

        

        function createPianoDiRisparmioModal(pianoId, pianoOggetto) {

            let modal = document.getElementById(`pianoModal_${pianoId}`);
            if (modal) {
                modal.remove(); // Rimuove il modal esistente dal DOM
            }
        
            modal = document.createElement('div');
            modal.id = `pianoModal_${pianoId}`;
            modal.classList.add('modal');
        
            // Contenuto dinamico del modal
            modal.innerHTML = `
                <div class="modal-content" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -80%); z-index: 1000; pointer-events: auto; padding: 20px;">
        <button id="closeModelDettagliPiano_${pianoId}" style="border: none; background: none; font-size: 24px; cursor: pointer; float: right;">&times;</button>
        
        <div class="header-row" style="display: flex; align-items: center; padding: 10px 0; width: 65%;">
            <div style="flex: 1;">
                <span id="pianoNome_${pianoId}" style="font-size: 18px; font-weight: bold;">${pianoOggetto.conto}</span>
            </div>
            <div style="display: flex; align-items: center; margin-left: auto;">
                <i class="bi bi-trash" id="deletePianoIcon_${pianoId}" style="font-size: 20px; cursor: pointer;"></i>
            </div>
        </div>
        
        <div class="details-section" style="padding: 10px; width: 70%;">
            <!-- Divider -->
            <div class="divider" style="border-bottom: 1px solid #ddd; margin: 10px 0;"></div>
            
            <!-- Obiettivo -->
            <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                <p id = "ObbiettivoPiano_${pianoId}" style="margin: 0;"><strong>Goal:</strong> €${pianoOggetto.obbiettivo}</p>
                <i class="bi bi-pencil" id="editObbiettivo_${pianoId}" style="font-size: 20px; cursor: pointer;"></i>
            </div>

            <!-- Divider -->
            <div class="divider" style="border-bottom: 1px solid #ddd; margin: 10px 0;"></div>

            <!-- Data di Scadenza -->
            <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                <p id = "ScadenzaPiano_${pianoId}" style="margin: 0;"><strong>Due date:</strong> ${pianoOggetto.data_scadenza}</p>
                <i class="bi bi-pencil" id="editScadenza_${pianoId}" style="font-size: 20px; cursor: pointer;"></i>
            </div>

            <!-- Divider -->
            <div class="divider" style="border-bottom: 1px solid #ddd; margin: 10px 0;"></div>

            <!-- Data di Creazione -->
            <p><strong>Creation date:</strong> ${pianoOggetto.data_creazione}</p>

            <!-- Divider -->
            <div class="divider" style="border-bottom: 1px solid #ddd; margin: 10px 0;"></div>

            <!-- Percentuale di Completamento -->
            <p id = "PercentualePiano_${pianoId}" ><strong>Completion percentage:</strong> ${pianoOggetto.percentuale_completamento}%</p>
        </div>
    </div>

                `;
            
                document.body.appendChild(modal);
            
                // Gestione degli eventi per le icone di cancellazione e modifica
                const deleteIcon = document.getElementById(`deletePianoIcon_${pianoId}`);
                deleteIcon.addEventListener('click', function() {
                    deletePianoDiRisparmio(pianoId); // Funzione per eliminare il piano di risparmio
                });
            

                const editScadenza= document.getElementById(`editScadenza_${pianoId}`);
                editScadenza.addEventListener('click', function() {
                    editPianoDiRisparmio(pianoId,"scadenza"); // Funzione per modificare il piano di risparmio
                });
                

                const editObbiettivo = document.getElementById(`editObbiettivo_${pianoId}`);
                editObbiettivo.addEventListener('click', function() {
                    editPianoDiRisparmio(pianoId, "Obbiettivo"); // Funzione per modificare il piano di risparmio
                });

                const closeButtonDettagliPiano = document.getElementById(`closeModelDettagliPiano_${pianoId}`);
                if (closeButtonDettagliPiano) {
                    closeButtonDettagliPiano.addEventListener('click', function() {
                        modal = document.getElementById(`pianoModal_${pianoId}`);
                        if (modal) {
                            modal.style.display = 'none'; // Nasconde il modal impostando display a 'none'
                        }
                    });
                }
            
                modal.style.display = 'block'; // Mostra il modal
            };
            
    



            let currentClickListenerObbiettivoSpesa; // Variabile per tenere traccia del listener corrente


            function handleContoClickObbiettivoSpesa(event, dataset) {
                if (event.target && event.target.id.startsWith('obbiettivoSpesa_')) {
                    
                    const obbiettivoId = event.target.id.split('_')[1];
                    console.log("ciao" + (obbiettivoId));
                    const ObbiettivoOggetto = dataset.filter(obbiettivo => obbiettivo.id == obbiettivoId);
                    createObbiettivoSpesaModal(obbiettivoId, ObbiettivoOggetto[0]); // Crea e visualizza il modal per questo conto
                };
            };

            function createClickListenerObbiettivoSpesa(dataset) {
                return function(event) {
                    handleContoClickObbiettivoSpesa(event, dataset);
                };
            };
            
            function addClickListenerObbiettivoSpesa(dataset) {

                const obbiettiviContainer = document.getElementById('ObbiettiviContainer');
                
                if (currentClickListenerObbiettivoSpesa) {
                    obbiettiviContainer.removeEventListener('click', currentClickListenerObbiettivoSpesa); 
                }
            
                
                currentClickListenerObbiettivoSpesa = createClickListenerObbiettivoSpesa(dataset);
                obbiettiviContainer.addEventListener('click', currentClickListenerObbiettivoSpesa); // Aggiungi il nuovo listener
            };
        
            function updateObbiettivoSpesa(dataset) {
                addClickListenerObbiettivoSpesa(dataset);
            };

            updateObbiettivoSpesa(obbiettivi_spesa);
        
            





            
            function deleteObbiettivoSpesa(pianoId) {
        
                    const confirmDelete = confirm('Are you sure you want to delete this spending goal?');
                
                    if (confirmDelete) {
                        fetch("{% url 'elimina_obbiettivo_spesa' 0 %}".replace('0', pianoId), {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': '{{ csrf_token }}',  // Includi il token CSRF per sicurezza
                            },
                            body: JSON.stringify({})  // Invia un body vuoto (opzionale)
                        })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Network response was not ok');
                            }
                            return response.json();
                        })
                        .then(risposta => {
                            if(risposta.success)
                        
                            reloadPage()
                            })
                    
                        .catch(error => console.error('Errore durante l\'eliminazione del conto:', error));
                    }
                
            };
            
            function editObbiettivoSpesa(ObbiettivoId, tipo) {
                if(tipo == "scadenza"){
                const newDate = prompt('Enter the new due date (format YYYY-MM-DD):');

                if (newDate && /^\d{4}-\d{2}-\d{2}$/.test(newDate)) {
                    const today = new Date();
                    const newDateObj = new Date(newDate);
                    
                
        
                    if (newDateObj <= today) {
                        alert("The due date must be at least tomorrow.");
                    } else {
                        fetch("{% url 'cambia_data_scadenza_obbiettivoSpesa' 0 'new_date' %}".replace('0', ObbiettivoId).replace('new_date', encodeURIComponent(newDate)), {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': getCSRFToken()  // Recupera il token CSRF
                            },
                            body: JSON.stringify({})
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                
                                
                                document.getElementById(`ScadenzaObbiettivo_${ObbiettivoId}`).innerHTML = `<p id="ScadenzaPiano_${ObbiettivoId}" style="margin: 0;"><strong>Due date:</strong> ${newDate}</p>`;

                                closeButtonDettagliPiano = document.getElementById(`closeModalDettagliObbiettivo_${ObbiettivoId}`);
                                if (closeButtonDettagliPiano) {
                                closeButtonDettagliPiano.addEventListener('click', reloadPage);
                                }
                                alert('The due date has been successfully updated.');
                            } else {
                                alert('Error: ' + data.message);
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                        });
                    }
                    } else {
                        alert('Invalid date format. Please make sure to use the YYYY-MM-DD format.');
                    }
                    
                
                } else
                {
                    const newObbiettivo = prompt('Enter the new goal:');

            
                if (newObbiettivo) {
                    if ( newObbiettivo <= 0) {
                        alert("The amount must be positive");
                    } else {
                    fetch("{% url 'cambia_obbiettivo_obbiettivoSpesa' 0 'new_obbiettivo' %}".replace('0', ObbiettivoId).replace('new_obbiettivo', encodeURIComponent(newObbiettivo)), {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': getCSRFToken()  // Recupera il token CSRF
                            },
                            body: JSON.stringify({})
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                        
                                document.getElementById(`ImportoObbiettivo_${ObbiettivoId}`).innerHTML = `<p id = "ObbiettivoPiano_${ObbiettivoId}" style="margin: 0;"><strong>Goal:</strong> €${newObbiettivo}</p>`;

                                closeButtonDettagliPiano = document.getElementById(`closeModalDettagliObbiettivo_${ObbiettivoId}`);

                                document.getElementById(`PercentualeObbiettivo_${ObbiettivoId}`).innerHTML = `<p id = "PercentualePiano_${ObbiettivoId}" style="margin: 0;"><strong>Completion percentage:</strong> ${data.percentuale}%</p>`;

                                if (closeButtonDettagliPiano) {
                                closeButtonDettagliPiano.addEventListener('click', reloadPage);
                                }
                                alert('The goal date has been successfully updated.');
                            } else 
                                alert: ('error' + data.message);
                            })
                        .catch(error => {
                            console.error('Error:', error);
                        });
                    }
                    } else {
                        alert('Invalid date format. Please make sure to use the YYYY-MM-DD format.');
                    }
                    
                }
            };

            function createObbiettivoSpesaModal(obbiettivoId, obbiettivoOggetto) {

                let modal = document.getElementById(`obbiettivoSpesaModal_${obbiettivoId}`);
                if (modal) {
                    modal.remove(); // Rimuove il modal esistente dal DOM
                }
            
                modal = document.createElement('div');
                modal.id = `obbiettivoSpesaModal_${obbiettivoId}`;
                modal.classList.add('modal');
                
                console.log(obbiettivoId)
                // Contenuto dinamico del modal
                modal.innerHTML = `
                    <div class="modal-content" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -80%); z-index: 1000; pointer-events: auto; padding: 20px;">
                        <button id="closeModalDettagliObbiettivo_${obbiettivoId}" style="border: none; background: none; font-size: 24px; cursor: pointer; float: right;">&times;</button>
                        
                        <div class="header-row" style="display: flex; align-items: center; padding: 10px 0; width: 65%;">
                            <div style="flex: 1;">
                                <span id="obbiettivoTipo_${obbiettivoId}" style="font-size: 18px; font-weight: bold;">${obbiettivoOggetto.categoria_target.nome}</span>
                            </div>
                            <div style="display: flex; align-items: center; margin-left: auto;">
                                <i class="bi bi-trash" id="deleteObbiettivoIcon_${obbiettivoId}" style="font-size: 20px; cursor: pointer;"></i>
                            </div>
                        </div>
                        
                        <div class="details-section" style="padding: 10px; width: 70%;">
                            <!-- Divider -->
                            <div class="divider" style="border-bottom: 1px solid #ddd; margin: 10px 0;"></div>
                            
                            <!-- Importo Obbiettivo -->
                            <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                                <p id="ImportoObbiettivo_${obbiettivoId}" style="margin: 0;"><strong> Goal:</strong> €${obbiettivoOggetto.importo}</p>
                                <i class="bi bi-pencil" id="editImportoObbiettivo_${obbiettivoId}" style="font-size: 20px; cursor: pointer;"></i>
                            </div>
            
                            <!-- Divider -->
                            <div class="divider" style="border-bottom: 1px solid #ddd; margin: 10px 0;"></div>
            
                            <!-- Importo Speso -->
                            <p id="ImportoSpeso_${obbiettivoId}"><strong>Amount:</strong> €${obbiettivoOggetto.importo_speso}</p>
                            
                            <!-- Divider -->
                            <div class="divider" style="border-bottom: 1px solid #ddd; margin: 10px 0;"></div>
            
                            <!-- Data di Scadenza -->
                            <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                                <p id="ScadenzaObbiettivo_${obbiettivoId}" style="margin: 0;"><strong>Due date:</strong> ${obbiettivoOggetto.data_scadenza}</p>
                                <i class="bi bi-pencil" id="editScadenzaObbiettivo_${obbiettivoId}" style="font-size: 20px; cursor: pointer;"></i>
                            </div>
            
                            <!-- Divider -->
                            <div class="divider" style="border-bottom: 1px solid #ddd; margin: 10px 0;"></div>
            
                            <!-- Data di Creazione -->
                            <p><strong>Creation date:</strong> ${obbiettivoOggetto.data_creazione}</p>
            
                            <!-- Divider -->
                            <div class="divider" style="border-bottom: 1px solid #ddd; margin: 10px 0;"></div>
            
                            <!-- Percentuale di Completamento -->
                            <p id="PercentualeObbiettivo_${obbiettivoId}"><strong>Completion percentage:</strong> ${obbiettivoOggetto.percentuale_completamento}%</p>
                        </div>
                    </div>
                `;
            
                document.body.appendChild(modal);
            
                // Gestione degli eventi per le icone di cancellazione e modifica
                const deleteIcon = document.getElementById(`deleteObbiettivoIcon_${obbiettivoId}`);
                deleteIcon.addEventListener('click', function() {
                    deleteObbiettivoSpesa(obbiettivoId); // Funzione per eliminare l'obbiettivo di spesa
                });
            
                const editScadenza = document.getElementById(`editScadenzaObbiettivo_${obbiettivoId}`);
                editScadenza.addEventListener('click', function() {
                    editObbiettivoSpesa(obbiettivoId, "scadenza"); // Funzione per modificare la scadenza dell'obbiettivo
                });
            
                const editImportoObbiettivo = document.getElementById(`editImportoObbiettivo_${obbiettivoId}`);
                editImportoObbiettivo.addEventListener('click', function() {
                    editObbiettivoSpesa(obbiettivoId, "importo"); // Funzione per modificare l'importo dell'obbiettivo
                });
            
                const closeButtonDettagliObbiettivo = document.getElementById(`closeModalDettagliObbiettivo_${obbiettivoId}`);
                if (closeButtonDettagliObbiettivo) {
                    closeButtonDettagliObbiettivo.addEventListener('click', function() {
                        modal = document.getElementById(`obbiettivoSpesaModal_${obbiettivoId}`);
                        if (modal) {
                            modal.style.display = 'none'; // Nasconde il modal impostando display a 'none'
                        }
                    });
                }
            
                modal.style.display = 'block'; // Mostra il modal
            }
            






        });
        
</script>

{% endblock content %}

